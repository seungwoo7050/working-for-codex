```markdown
# CLAUDE.md - spring-patterns v3.3 OpenTelemetry 분산 추적

> AI 코딩 에이전트를 위한 프로젝트 컨텍스트 가이드 (시니어 레벨)

## 프로젝트 개요

### 선행 조건
- v3.0.0 마이크로서비스 분리 완료
- v3.1.0 gRPC 통신 완료
- v3.2.0 Saga 패턴 완료

### 현재 상태 (v3.2.0)
- Saga Orchestrator
- 보상 트랜잭션
- Kafka 이벤트

### 목표 상태 (v3.3.0)
- **OpenTelemetry 분산 추적**
- Jaeger 시각화
- 커스텀 스팬

## 버전 로드맵 (v3.3 세부화)

| 버전 | 기간 | 설명 |
|------|------|------|
| v3.3.0 | 0.5주 | OpenTelemetry SDK 설정 |
| v3.3.1 | 0.5주 | Jaeger 연동 |
| v3.3.2 | 0.5주 | 커스텀 스팬 |

---

## v3.3.0: OpenTelemetry SDK 설정

### 작업 내용
| 순서 | 작업 | 핵심 파일 |
|------|------|----------|
| 3.3.0.1 | OTel 의존성 | `build.gradle` |
| 3.3.0.2 | TracingConfig | `TracingConfig.java` |
| 3.3.0.3 | 스팬 전파 | `W3CTraceContext` |
| 3.3.0.4 | 자동 계측 | `application.yml` |

### 커밋 포인트
```bash
git commit -m "feat(tracing): add OpenTelemetry dependencies"
git commit -m "feat(tracing): configure OpenTelemetry SDK"
git commit -m "feat(tracing): add W3C trace context propagation"
git commit -m "feat(tracing): configure auto-instrumentation"
git tag -a v3.3.0 -m "v3.3.0: OpenTelemetry Setup"
```

### 상세 구현 가이드

#### 3.3.0.1 OpenTelemetry 설정
```java
// TracingConfig.java
@Configuration
public class TracingConfig {
    
    @Bean
    public OpenTelemetry openTelemetry(@Value("${spring.application.name}") String serviceName) {
        Resource resource = Resource.getDefault()
                .merge(Resource.create(Attributes.of(
                        ResourceAttributes.SERVICE_NAME, serviceName,
                        ResourceAttributes.SERVICE_VERSION, "3.3.0"
                )));
        
        SdkTracerProvider tracerProvider = SdkTracerProvider.builder()
                .addSpanProcessor(BatchSpanProcessor.builder(
                        OtlpGrpcSpanExporter.builder()
                                .setEndpoint("http://jaeger:4317")
                                .build())
                        .build())
                .setResource(resource)
                .setSampler(Sampler.parentBased(Sampler.traceIdRatioBased(0.1))) // 10% 샘플링
                .build();
        
        return OpenTelemetrySdk.builder()
                .setTracerProvider(tracerProvider)
                .setPropagators(ContextPropagators.create(
                        TextMapPropagator.composite(
                                W3CTraceContextPropagator.getInstance(),
                                W3CBaggagePropagator.getInstance()
                        )
                ))
                .buildAndRegisterGlobal();
    }
    
    @Bean
    public Tracer tracer(OpenTelemetry openTelemetry) {
        return openTelemetry.getTracer("spring-patterns");
    }
}
```

---

## v3.3.1: Jaeger 연동

### 작업 내용
| 순서 | 작업 | 핵심 파일 |
|------|------|----------|
| 3.3.1.1 | Jaeger 인프라 | `docker-compose.yml` |
| 3.3.1.2 | OTLP Exporter | `TracingConfig.java` |
| 3.3.1.3 | 서비스 맵 | Jaeger UI |

### 커밋 포인트
```bash
git commit -m "infra(jaeger): add Jaeger for trace visualization"
git commit -m "feat(tracing): configure OTLP exporter"
git commit -m "docs: add Jaeger dashboard guide"
git tag -a v3.3.1 -m "v3.3.1: Jaeger Integration"
```

### 상세 구현 가이드

#### 3.3.1.1 Jaeger 설정
```yaml
# docker-compose.yml
services:
  jaeger:
    image: jaegertracing/all-in-one:1.50
    ports:
      - "16686:16686"  # UI
      - "4317:4317"    # OTLP gRPC
      - "4318:4318"    # OTLP HTTP
    environment:
      - COLLECTOR_OTLP_ENABLED=true

# application.yml
management:
  tracing:
    sampling:
      probability: 1.0  # 개발 환경: 100%
  otlp:
    tracing:
      endpoint: http://jaeger:4318/v1/traces
```

---

## v3.3.2: 커스텀 스팬

### 작업 내용
| 순서 | 작업 | 핵심 파일 |
|------|------|----------|
| 3.3.2.1 | 비즈니스 스팬 | `TracingAspect.java` |
| 3.3.2.2 | 스팬 속성 | `SpanAttributes.java` |
| 3.3.2.3 | 에러 추적 | `TracingAspect.java` |

### 커밋 포인트
```bash
git commit -m "feat(tracing): add custom spans with AOP"
git commit -m "feat(tracing): add business span attributes"
git commit -m "feat(tracing): add error tracking in spans"
git tag -a v3.3.2 -m "v3.3.2: Distributed Tracing Complete"
```

### 상세 구현 가이드

#### 3.3.2.1 커스텀 스팬
```java
// TracingAspect.java
@Aspect
@Component
@RequiredArgsConstructor
public class TracingAspect {
    
    private final Tracer tracer;
    
    @Around("@annotation(traced)")
    public Object traceMethod(ProceedingJoinPoint joinPoint, Traced traced) throws Throwable {
        String spanName = traced.value().isEmpty() 
                ? joinPoint.getSignature().getName() 
                : traced.value();
        
        Span span = tracer.spanBuilder(spanName)
                .setSpanKind(SpanKind.INTERNAL)
                .setAttribute("class", joinPoint.getTarget().getClass().getSimpleName())
                .setAttribute("method", joinPoint.getSignature().getName())
                .startSpan();
        
        try (Scope scope = span.makeCurrent()) {
            Object result = joinPoint.proceed();
            span.setStatus(StatusCode.OK);
            return result;
        } catch (Exception e) {
            span.setStatus(StatusCode.ERROR, e.getMessage());
            span.recordException(e);
            throw e;
        } finally {
            span.end();
        }
    }
}

// annotation/Traced.java
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
public @interface Traced {
    String value() default "";
}

// 사용 예시
@Service
public class OrderService {
    
    @Traced("create-order")
    public Mono<Order> createOrder(CreateOrderRequest request) {
        Span currentSpan = Span.current();
        currentSpan.setAttribute("customer.id", request.getCustomerId());
        currentSpan.setAttribute("items.count", request.getItems().size());
        
        // 비즈니스 로직
    }
}
```

## 파일 구조

```
spring-patterns/
├── common/
│   └── tracing/
│       ├── TracingConfig.java
│       ├── TracingAspect.java
│       └── Traced.java
└── docker-compose.yml (Jaeger 포함)
```

## 추적 가능 정보

| 항목 | 설명 |
|------|------|
| Trace ID | 전체 요청 흐름 식별 |
| Span ID | 개별 작업 식별 |
| Parent Span | 호출 관계 |
| Duration | 소요 시간 |
| Attributes | 커스텀 메타데이터 |
| Events | 스팬 내 이벤트 |
| Status | 성공/실패 상태 |
```

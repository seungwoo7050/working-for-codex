# 관측성 & 부하 테스트 설계 (v1.4.2)
> UDP 메트릭, 패킷 손실 시뮬레이션, 부하 테스트, Grafana 대시보드 구현 설계

## 1. 개요

### 1.1 목표
- UDP 전용 Prometheus 메트릭 추가
- 네트워크 조건 시뮬레이션 (패킷 손실, 지연)
- 재현 가능한 부하 테스트 프레임워크
- Grafana UDP 성능 대시보드

### 1.2 배경
UDP 기반 넷코드는 TCP와 다른 성능 특성을 가집니다:
- 패킷 손실률 측정 필요
- RTT(Round-Trip Time) 모니터링
- 예측 정확도 추적
- 리컨실리에이션 빈도 분석

---

## 2. 패치별 설계

### 2.1 패치 1.4.2-p1: UDP 메트릭 추가

#### 2.1.1 책임
- UDP 관련 Prometheus 메트릭 정의
- 실시간 메트릭 수집
- 기존 MetricsHttpServer 확장

#### 2.1.2 메트릭 정의
```cpp
// include/pvpserver/network/udp_metrics.h
namespace pvpserver::network {

class UdpMetrics {
public:
    static UdpMetrics& instance();

    // 패킷 통계
    void recordPacketSent(size_t bytes);
    void recordPacketReceived(size_t bytes);
    void recordPacketLost();
    
    // RTT 측정
    void recordRtt(uint32_t clientId, float rttMs);
    
    // 넷코드 통계
    void recordPrediction(bool accurate);
    void recordReconciliation(float positionError);
    void recordInputBufferSize(size_t size);
    
    // 스냅샷/델타 통계
    void recordSnapshotSize(size_t bytes);
    void recordDeltaSize(size_t bytes);
    void recordDeltaRatio(float ratio);  // delta_size / snapshot_size

    // Prometheus 형식으로 출력
    std::string toPrometheusFormat() const;

private:
    // Counters
    std::atomic<uint64_t> packetsSent_{0};
    std::atomic<uint64_t> packetsReceived_{0};
    std::atomic<uint64_t> packetsLost_{0};
    std::atomic<uint64_t> bytesSent_{0};
    std::atomic<uint64_t> bytesReceived_{0};
    
    // Gauges
    std::atomic<float> avgRttMs_{0};
    std::atomic<float> predictionAccuracy_{0};
    std::atomic<uint64_t> reconciliationCount_{0};
    
    // Histograms (버킷별 카운트)
    struct RttHistogram {
        std::atomic<uint64_t> bucket_10ms{0};   // <= 10ms
        std::atomic<uint64_t> bucket_25ms{0};   // <= 25ms
        std::atomic<uint64_t> bucket_50ms{0};   // <= 50ms
        std::atomic<uint64_t> bucket_100ms{0};  // <= 100ms
        std::atomic<uint64_t> bucket_inf{0};    // > 100ms
    } rttHistogram_;
};

}  // namespace pvpserver::network
```

#### 2.1.3 Prometheus 출력 형식
```
# HELP pvp_udp_packets_total Total UDP packets
# TYPE pvp_udp_packets_total counter
pvp_udp_packets_total{direction="sent"} 12345
pvp_udp_packets_total{direction="received"} 12340
pvp_udp_packets_total{direction="lost"} 5

# HELP pvp_udp_bytes_total Total UDP bytes
# TYPE pvp_udp_bytes_total counter
pvp_udp_bytes_total{direction="sent"} 1234567
pvp_udp_bytes_total{direction="received"} 1234000

# HELP pvp_rtt_milliseconds RTT histogram
# TYPE pvp_rtt_milliseconds histogram
pvp_rtt_milliseconds_bucket{le="10"} 100
pvp_rtt_milliseconds_bucket{le="25"} 500
pvp_rtt_milliseconds_bucket{le="50"} 800
pvp_rtt_milliseconds_bucket{le="100"} 950
pvp_rtt_milliseconds_bucket{le="+Inf"} 1000

# HELP pvp_prediction_accuracy Prediction accuracy ratio
# TYPE pvp_prediction_accuracy gauge
pvp_prediction_accuracy 0.95

# HELP pvp_reconciliation_total Total reconciliations
# TYPE pvp_reconciliation_total counter
pvp_reconciliation_total 123
```

---

### 2.2 패치 1.4.2-p2: 패킷 손실 시뮬레이션

#### 2.2.1 책임
- 네트워크 조건 시뮬레이션 (테스트용)
- 패킷 손실, 지연, 중복, 순서 변경
- 설정 가능한 파라미터

#### 2.2.2 인터페이스
```cpp
// include/pvpserver/network/packet_simulator.h
namespace pvpserver::network {

struct NetworkCondition {
    float packetLossRate = 0.0f;      // 0.0 ~ 1.0
    float latencyMs = 0.0f;           // 추가 지연 (ms)
    float latencyJitterMs = 0.0f;     // 지연 변동 (±ms)
    float duplicateRate = 0.0f;       // 패킷 중복률
    float reorderRate = 0.0f;         // 순서 변경률
};

class PacketSimulator {
public:
    void setCondition(const NetworkCondition& condition);
    const NetworkCondition& getCondition() const;

    // 패킷 처리 (시뮬레이션 적용)
    // 반환: 전달할 패킷 목록 (지연, 중복 포함)
    std::vector<DelayedPacket> process(
        const std::vector<uint8_t>& packet,
        const Endpoint& target
    );

    // 지연된 패킷 중 전달할 것들 가져오기
    std::vector<ReadyPacket> getReadyPackets(uint64_t currentTime);

    // 통계
    struct Stats {
        uint64_t dropped;
        uint64_t delayed;
        uint64_t duplicated;
        uint64_t reordered;
    };
    Stats getStats() const;

private:
    NetworkCondition condition_;
    std::priority_queue<DelayedPacket> delayedQueue_;
    std::mt19937 rng_{std::random_device{}()};
    Stats stats_{};
};

}  // namespace pvpserver::network
```

#### 2.2.3 시뮬레이션 흐름
```
1. 패킷 전송 요청
2. 손실 확률 체크 → 드롭 결정
3. 중복 확률 체크 → 복제 생성
4. 지연 계산 (base + jitter)
5. 순서 변경 확률 체크 → 추가 지연
6. 지연 큐에 추가
7. 시간 경과 후 전달
```

#### 2.2.4 프리셋 조건
```cpp
// 일반적인 네트워크 시나리오
static const NetworkCondition GOOD_WIFI = {
    .packetLossRate = 0.001f,  // 0.1%
    .latencyMs = 20.0f,
    .latencyJitterMs = 5.0f
};

static const NetworkCondition BAD_WIFI = {
    .packetLossRate = 0.05f,   // 5%
    .latencyMs = 100.0f,
    .latencyJitterMs = 50.0f
};

static const NetworkCondition MOBILE_4G = {
    .packetLossRate = 0.02f,   // 2%
    .latencyMs = 60.0f,
    .latencyJitterMs = 30.0f
};

static const NetworkCondition STRESS_TEST = {
    .packetLossRate = 0.10f,   // 10%
    .latencyMs = 200.0f,
    .latencyJitterMs = 100.0f
};
```

---

### 2.3 패치 1.4.2-p3: 재현 가능한 부하 테스트

#### 2.3.1 책임
- 다중 가상 클라이언트 생성
- 재현 가능한 시드 기반 테스트
- 성능 메트릭 수집 및 보고

#### 2.3.2 인터페이스
```cpp
// server/tests/performance/udp_load_test.h
namespace pvpserver::test {

struct LoadTestConfig {
    uint32_t numClients = 100;
    uint32_t durationSeconds = 60;
    uint32_t rampUpSeconds = 10;
    uint64_t randomSeed = 12345;      // 재현성
    NetworkCondition networkCondition;
    std::string serverHost = "127.0.0.1";
    uint16_t serverPort = 7777;
};

struct LoadTestResult {
    // 처리량
    uint64_t totalPacketsSent;
    uint64_t totalPacketsReceived;
    double avgPacketsPerSecond;
    
    // 지연
    double avgRttMs;
    double p50RttMs;
    double p95RttMs;
    double p99RttMs;
    
    // 손실
    double packetLossRate;
    
    // 넷코드
    double avgPredictionAccuracy;
    double reconciliationRate;
    
    // 서버
    double avgCpuUsage;
    double peakMemoryMb;
};

class UdpLoadTest {
public:
    explicit UdpLoadTest(const LoadTestConfig& config);

    // 테스트 실행
    LoadTestResult run();

    // 실시간 상태 조회
    struct LiveStats {
        uint32_t activeClients;
        double currentPacketsPerSecond;
        double currentAvgRttMs;
    };
    LiveStats getLiveStats() const;

    // 중단
    void stop();

private:
    LoadTestConfig config_;
    std::vector<std::unique_ptr<VirtualClient>> clients_;
    std::atomic<bool> running_{false};
};

}  // namespace pvpserver::test
```

#### 2.3.3 가상 클라이언트
```cpp
class VirtualClient {
public:
    VirtualClient(uint32_t id, uint64_t seed);

    // 주기적으로 입력 생성 (시드 기반)
    void tick(float deltaTime);

    // 서버 응답 처리
    void handleServerPacket(const std::vector<uint8_t>& data);

    // 통계
    struct ClientStats {
        uint64_t packetsSent;
        uint64_t packetsReceived;
        std::vector<float> rttSamples;
        uint32_t mispredictions;
    };
    ClientStats getStats() const;

private:
    uint32_t id_;
    std::mt19937 rng_;  // 시드 기반 RNG
    PlayerState predictedState_;
};
```

#### 2.3.4 보고서 형식
```
========================================
UDP Load Test Report
========================================
Config:
  Clients: 100
  Duration: 60s
  Seed: 12345
  Network: GOOD_WIFI

Results:
  Throughput:
    Packets Sent: 360,000
    Packets Received: 359,640
    Avg PPS: 6,000
  
  Latency:
    Avg RTT: 22.5ms
    P50 RTT: 20.0ms
    P95 RTT: 35.0ms
    P99 RTT: 48.0ms
  
  Packet Loss: 0.1%
  
  Netcode:
    Prediction Accuracy: 98.5%
    Reconciliation Rate: 1.5%
  
  Server:
    Avg CPU: 45%
    Peak Memory: 128MB

Status: PASS
========================================
```

---

### 2.4 패치 1.4.2-p4: Grafana 대시보드

#### 2.4.1 책임
- UDP 성능 시각화 대시보드
- 실시간 모니터링
- 알림 설정

#### 2.4.2 대시보드 구성
```json
// monitoring/grafana/dashboards/udp-dashboard.json
{
  "title": "UDP Netcode Performance",
  "panels": [
    {
      "title": "Packet Rate",
      "type": "graph",
      "targets": [
        {"expr": "rate(pvp_udp_packets_total[1m])"}
      ]
    },
    {
      "title": "Packet Loss Rate",
      "type": "gauge",
      "targets": [
        {"expr": "pvp_udp_packets_total{direction='lost'} / pvp_udp_packets_total{direction='sent'}"}
      ]
    },
    {
      "title": "RTT Distribution",
      "type": "heatmap",
      "targets": [
        {"expr": "pvp_rtt_milliseconds_bucket"}
      ]
    },
    {
      "title": "Prediction Accuracy",
      "type": "stat",
      "targets": [
        {"expr": "pvp_prediction_accuracy"}
      ]
    },
    {
      "title": "Reconciliation Rate",
      "type": "graph",
      "targets": [
        {"expr": "rate(pvp_reconciliation_total[1m])"}
      ]
    },
    {
      "title": "Delta Compression Ratio",
      "type": "graph",
      "targets": [
        {"expr": "avg(pvp_delta_ratio)"}
      ]
    }
  ]
}
```

#### 2.4.3 패널 상세

| 패널 | 타입 | 메트릭 | 설명 |
|------|------|--------|------|
| Packet Rate | Graph | `rate(pvp_udp_packets_total[1m])` | 초당 패킷 수 |
| Packet Loss | Gauge | `lost / sent` | 손실률 (%) |
| RTT Heatmap | Heatmap | `pvp_rtt_milliseconds_bucket` | RTT 분포 |
| Bandwidth | Graph | `rate(pvp_udp_bytes_total[1m])` | 대역폭 (bytes/s) |
| Predictions | Stat | `pvp_prediction_accuracy` | 예측 정확도 |
| Reconciliations | Graph | `rate(pvp_reconciliation_total[1m])` | 리컨실리에이션/초 |
| Delta Ratio | Graph | `avg(pvp_delta_ratio)` | 델타 압축률 |

#### 2.4.4 알림 규칙
```yaml
# Packet Loss Alert
- alert: HighPacketLoss
  expr: pvp_udp_packets_lost / pvp_udp_packets_sent > 0.05
  for: 1m
  labels:
    severity: warning
  annotations:
    summary: "High packet loss rate detected (> 5%)"

# High Latency Alert
- alert: HighLatency
  expr: pvp_rtt_milliseconds_avg > 100
  for: 2m
  labels:
    severity: warning
  annotations:
    summary: "Average RTT exceeds 100ms"

# Low Prediction Accuracy
- alert: LowPredictionAccuracy
  expr: pvp_prediction_accuracy < 0.90
  for: 5m
  labels:
    severity: info
  annotations:
    summary: "Prediction accuracy below 90%"
```

---

## 3. 기존 코드와의 연관성

### 3.1 영향받는 모듈
| 모듈 | 변경 유형 | 설명 |
|------|----------|------|
| `network/udp_metrics.h` | 신규 | UDP 메트릭 클래스 |
| `network/packet_simulator.h` | 신규 | 네트워크 시뮬레이터 |
| `network/metrics_http_server.cpp` | 수정 | UDP 메트릭 노출 |
| `tests/performance/` | 추가 | 부하 테스트 |
| `monitoring/grafana/` | 추가 | 대시보드 JSON |

### 3.2 의존성
```
UdpGameServer
    ├── UdpMetrics (메트릭 수집)
    └── PacketSimulator (테스트 시)

UdpLoadTest
    ├── VirtualClient (가상 클라이언트)
    ├── PacketSimulator (네트워크 조건)
    └── UdpMetrics (결과 수집)
```

---

## 4. 파일 구조

```
server/
├── include/pvpserver/
│   └── network/
│       ├── udp_metrics.h         # 신규
│       └── packet_simulator.h    # 신규
├── src/
│   └── network/
│       ├── udp_metrics.cpp       # 신규
│       └── packet_simulator.cpp  # 신규
└── tests/
    └── performance/
        ├── udp_load_test.h       # 신규
        ├── udp_load_test.cpp     # 신규
        └── virtual_client.cpp    # 신규

monitoring/
└── grafana/
    └── dashboards/
        └── udp-dashboard.json    # 신규
```

---

## 5. 성능 요구사항

| 메트릭 | 목표 |
|--------|------|
| 메트릭 수집 오버헤드 | < 1% CPU |
| 시뮬레이터 처리 | < 0.01ms/packet |
| 부하 테스트 클라이언트 | 1000+ 동시 |
| 대시보드 새로고침 | 1초 간격 |

---

## 6. 테스트 전략

### 6.1 메트릭 테스트
- Prometheus 형식 파싱 검증
- 동시성 안전성 (atomic 연산)
- 히스토그램 버킷 정확성

### 6.2 시뮬레이터 테스트
- 확률 분포 검증 (다수 실행)
- 재현성 검증 (동일 시드 → 동일 결과)
- 지연 타이밍 정확성

### 6.3 부하 테스트 검증
- 결과 재현성
- 서버 안정성 (OOM, 크래시 없음)
- 메트릭 정합성

# 프로덕션 배포 & Docker Compose 설계 일지 (v3.0)
> Phase 3 완성 - 프로덕션 환경 구축 및 종합 문서화

## 1. 문제 정의 & 요구사항

### 1.1 핵심 목표

**Phase 3 - 프로덕션 완성**:
- **Docker Compose**: 모든 서비스 오케스트레이션
- **멀티 컨테이너**: Frontend, Backend, PostgreSQL, Redis, Prometheus, Grafana
- **볼륨 관리**: 데이터 영속성 보장
- **네트워크**: 서비스 간 통신 격리

**배포 환경**:
- **개발**: `docker-compose.yml` (핫 리로드, 디버깅)
- **프로덕션**: `docker-compose.prod.yml` (최적화 빌드, 보안)

### 1.2 컨테이너 구성

#### 1.2.1 Frontend (React + Vite)
- **이미지**: node:20-alpine
- **포트**: 5173
- **볼륨**: 소스 코드 마운트 (개발)
- **환경변수**: VITE_API_URL

#### 1.2.2 Backend (Node.js + FFmpeg + Native Addon)
- **이미지**: 커스텀 (node:20-alpine + FFmpeg + build tools)
- **포트**: 3001 (HTTP), 3002 (WebSocket)
- **볼륨**: uploads/, outputs/, node_modules
- **환경변수**: DB_HOST, REDIS_HOST

#### 1.2.3 PostgreSQL
- **이미지**: postgres:15
- **포트**: 5432
- **볼륨**: postgres_data (영속성)
- **환경변수**: POSTGRES_DB, POSTGRES_USER, POSTGRES_PASSWORD

#### 1.2.4 Redis
- **이미지**: redis:7-alpine
- **포트**: 6379
- **볼륨**: redis_data

#### 1.2.5 Prometheus
- **이미지**: prom/prometheus:latest
- **포트**: 9090
- **볼륨**: prometheus.yml 설정

#### 1.2.6 Grafana
- **이미지**: grafana/grafana:latest
- **포트**: 3000
- **볼륨**: grafana_data, provisioning/, dashboards/
- **환경변수**: GF_SECURITY_ADMIN_PASSWORD

---

## 2. Docker 구조

### 2.1 Backend Dockerfile

**파일**: `backend/Dockerfile:1-34`

```dockerfile
FROM node:20-alpine

# Install FFmpeg and development libraries for native addon compilation
RUN apk add --no-cache \
    ffmpeg \
    ffmpeg-dev \
    python3 \
    make \
    g++ \
    gcc \
    linux-headers

WORKDIR /app

# Install backend dependencies
COPY backend/package*.json ./
RUN npm install

# Build native addon
COPY native /app/native
WORKDIR /app/native
RUN npm install && npm run build

# Copy backend source
WORKDIR /app
COPY backend .

# Build TypeScript
RUN npm run build

EXPOSE 3001 3002

CMD ["npm", "run", "start"]
```

**핵심 포인트**:
1. **Alpine Linux**: 경량 이미지 (< 200MB)
2. **FFmpeg 설치**: apk add ffmpeg ffmpeg-dev
3. **Build tools**: python3, make, g++ (Native Addon 빌드용)
4. **멀티 스테이지**: native/ → backend/ → dist/

### 2.2 Docker Compose 전체 구성

**파일**: `deployments/docker/docker-compose.yml:1-82`

```yaml
version: '3.8'

services:
  frontend:
    build: ../../frontend
    ports:
      - "5173:5173"
    volumes:
      - ../../frontend:/app
      - /app/node_modules
    environment:
      - VITE_API_URL=http://localhost:3001

  backend:
    build:
      context: ../..
      dockerfile: backend/Dockerfile
    ports:
      - "3001:3001"
      - "3002:3002"  # WebSocket
    volumes:
      - ../../backend:/app
      - /app/node_modules
      - /app/native  # Preserve built native addon
      - /app/dist    # Preserve built TypeScript
      - ../../backend/uploads:/app/uploads
      - ../../backend/outputs:/app/outputs
    environment:
      - DB_HOST=postgres
      - DB_NAME=video_editor
      - DB_USER=admin
      - DB_PASSWORD=password
      - REDIS_HOST=redis
    depends_on:
      - postgres
      - redis

  postgres:
    image: postgres:15
    environment:
      POSTGRES_DB: video_editor
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: password
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data

  prometheus:
    image: prom/prometheus:latest
    volumes:
      - ../../monitoring/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
    ports:
      - "9090:9090"

  grafana:
    image: grafana/grafana:latest
    ports:
      - "3000:3000"
    volumes:
      - grafana_data:/var/lib/grafana
      - ../../monitoring/grafana/provisioning:/etc/grafana/provisioning
      - ../../monitoring/grafana/dashboards:/var/lib/grafana/dashboards
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_SECURITY_ADMIN_USER=admin
      - GF_USERS_ALLOW_SIGN_UP=false
    depends_on:
      - prometheus

volumes:
  postgres_data:
  redis_data:
  grafana_data:
```

---

## 3. 배포 전략

### 3.1 개발 환경 실행

```bash
# 1. 모든 서비스 시작
docker compose -f deployments/docker/docker-compose.yml up -d

# 2. 로그 확인
docker compose logs -f backend

# 3. 서비스 확인
curl http://localhost:3001/health
```

### 3.2 프로덕션 환경 실행

```bash
# 1. 프로덕션 이미지 빌드
docker compose -f deployments/docker/docker-compose.prod.yml build

# 2. 프로덕션 시작
docker compose -f deployments/docker/docker-compose.prod.yml up -d

# 3. 상태 확인
docker compose ps
```

### 3.3 데이터 백업

```bash
# PostgreSQL 백업
docker compose exec postgres pg_dump -U admin video-editor > backup.sql

# Redis 백업
docker compose exec redis redis-cli SAVE
docker cp $(docker compose ps -q redis):/data/dump.rdb ./redis-backup.rdb
```

### 3.4 스케일링

```bash
# Backend 인스턴스 3개로 확장
docker compose up -d --scale backend=3

# 로드밸런서 추가 필요 (nginx)
```

---

## 4. 네트워크 아키텍처

```
┌───────────────────────────────────────────────────────┐
│               Docker Bridge Network                   │
└───────────────────────────────────────────────────────┘

┌────────────┐   ┌────────────┐   ┌────────────┐
│  Frontend  │   │  Backend   │   │ Prometheus │
│  :5173     │◀─▶│  :3001     │◀─▶│  :9090     │
└────────────┘   └────────────┘   └────────────┘
                       ▲ ▲                ▼
                       │ │        ┌────────────┐
                       │ │        │  Grafana   │
                       │ │        │  :3000     │
                       │ │        └────────────┘
                       │ │
           ┌───────────┘ └───────────┐
           ▼                         ▼
    ┌────────────┐           ┌────────────┐
    │ PostgreSQL │           │   Redis    │
    │  :5432     │           │   :6379    │
    └────────────┘           └────────────┘
```

---

## 5. 환경 변수 관리

### 5.1 .env 파일 구조

```bash
# Database
POSTGRES_HOST=postgres
POSTGRES_PORT=5432
POSTGRES_DB=video-editor
POSTGRES_USER=admin
POSTGRES_PASSWORD=changeme_in_production

# Redis
REDIS_HOST=redis
REDIS_PORT=6379

# Backend
PORT=3001
UPLOAD_DIR=/app/uploads
OUTPUT_DIR=/app/outputs

# Frontend
VITE_API_URL=http://localhost:3001
VITE_WS_URL=ws://localhost:3002

# Grafana
GF_SECURITY_ADMIN_PASSWORD=changeme_in_production
```

### 5.2 Secrets 관리 (프로덕션)

```bash
# Docker Secrets 사용
echo "super_secret_password" | docker secret create db_password -

# docker-compose.prod.yml
services:
  backend:
    secrets:
      - db_password
    environment:
      - DB_PASSWORD_FILE=/run/secrets/db_password
```

---

## 6. 헬스 체크

### 6.1 서비스 헬스 체크

```yaml
# docker-compose.yml
services:
  backend:
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  postgres:
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U admin"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3
```

---

## 7. 로그 관리

### 7.1 로그 드라이버 설정

```yaml
services:
  backend:
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
```

### 7.2 로그 확인

```bash
# 실시간 로그
docker compose logs -f backend

# 마지막 100줄
docker compose logs --tail=100 backend

# 특정 시간 이후
docker compose logs --since="2025-11-23T10:00:00" backend
```

---

## 8. 모니터링 & 알림

### 8.1 Prometheus 메트릭 수집

```yaml
# prometheus.yml
scrape_configs:
  - job_name: 'video-editor'
    static_configs:
      - targets: ['backend:3001']
    metrics_path: '/metrics'
    scrape_interval: 15s
```

### 8.2 Grafana 대시보드

```bash
# Grafana 접속
http://localhost:3000

# 로그인: admin / admin

# 대시보드 확인:
# - native-video-editor Overview
# - API Performance
# - System Resources
```

---

## 9. 보안 고려사항

### 9.1 네트워크 격리

```yaml
networks:
  frontend_net:
    driver: bridge
  backend_net:
    driver: bridge
    internal: true  # 외부 접근 차단

services:
  frontend:
    networks:
      - frontend_net

  backend:
    networks:
      - frontend_net
      - backend_net

  postgres:
    networks:
      - backend_net  # 내부 네트워크만
```

### 9.2 포트 노출 최소화

```yaml
# 프로덕션: 포트 노출 최소화
services:
  postgres:
    # ports 제거 (외부 접근 차단)
    expose:
      - "5432"  # 내부 통신만
```

---

## 10. 트러블슈팅

### 10.1 Native Addon 빌드 실패

```bash
# 컨테이너 내부 접속
docker compose exec backend sh

# 수동 빌드
cd /app/native
npm run build

# 로그 확인
cat /app/native/build/Release/build.log
```

### 10.2 PostgreSQL 연결 실패

```bash
# PostgreSQL 상태 확인
docker compose exec postgres pg_isready -U admin

# 연결 테스트
docker compose exec backend psql -h postgres -U admin -d video-editor
```

---

## 11. 성능 최적화

### 11.1 Docker 빌드 캐시

```dockerfile
# package.json 먼저 복사 (캐시 활용)
COPY package*.json ./
RUN npm install

# 소스 나중에 복사
COPY . .
```

### 11.2 멀티 스테이지 빌드 (프로덕션)

```dockerfile
# Stage 1: Build
FROM node:20-alpine AS builder
WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production

# Stage 2: Runtime
FROM node:20-alpine
COPY --from=builder /app/node_modules ./node_modules
COPY dist ./dist
CMD ["node", "dist/server.js"]
```

---

## 12. 체크리스트

### Docker
- [x] Backend Dockerfile
- [x] Frontend Dockerfile
- [x] docker-compose.yml (개발)
- [x] docker-compose.prod.yml (프로덕션)
- [x] .dockerignore

### 서비스
- [x] Frontend 컨테이너
- [x] Backend 컨테이너
- [x] PostgreSQL
- [x] Redis
- [x] Prometheus
- [x] Grafana

### 운영
- [x] 헬스 체크
- [x] 로그 관리
- [x] 볼륨 백업
- [x] 환경 변수 관리

---

## 13. Voyager X 매칭

| 요구사항 | 구현 | 증명 |
|----------|------|------|
| 프로덕션 운영 | ✅ Docker Compose 전체 스택 | 완벽한 오케스트레이션 |
| 시스템 설계 | ✅ 멀티 컨테이너 아키텍처 | 서비스 분리 |
| DevOps | ✅ 모니터링, 백업, 로깅 | 운영 자동화 |

**Phase 3 완료**: ⭐⭐⭐⭐⭐ (Production-Ready)

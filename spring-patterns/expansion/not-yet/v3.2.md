```markdown
# CLAUDE.md - spring-patterns v3.2 Saga 분산 트랜잭션

> AI 코딩 에이전트를 위한 프로젝트 컨텍스트 가이드 (시니어 레벨)

## 프로젝트 개요

### 선행 조건
- v3.0.0 마이크로서비스 분리 완료
- v3.1.0 gRPC 통신 완료

### 현재 상태 (v3.1.0)
- Protobuf 스키마
- gRPC Server/Client
- 스트리밍 API

### 목표 상태 (v3.2.0)
- **Saga 분산 트랜잭션**
- 보상 트랜잭션
- Kafka 이벤트

## 버전 로드맵 (v3.2 세부화)

| 버전 | 기간 | 설명 |
|------|------|------|
| v3.2.0 | 1주 | Saga Orchestrator |
| v3.2.1 | 0.5주 | 보상 트랜잭션 |
| v3.2.2 | 0.5주 | Kafka 이벤트 통합 |

---

## v3.2.0: Saga Orchestrator

### 작업 내용
| 순서 | 작업 | 핵심 파일 |
|------|------|----------|
| 3.2.0.1 | Saga 인터페이스 | `saga/Saga.java` |
| 3.2.0.2 | CreateOrderSaga | `saga/CreateOrderSaga.java` |
| 3.2.0.3 | Saga Orchestrator | `saga/SagaOrchestrator.java` |
| 3.2.0.4 | Saga State 저장소 | `saga/SagaStateRepository.java` |

### 커밋 포인트
```bash
git commit -m "feat(saga): define Saga interfaces and base classes"
git commit -m "feat(saga): implement CreateOrderSaga with step execution"
git commit -m "feat(saga): implement Saga Orchestrator with state machine"
git commit -m "feat(saga): add Saga state persistence"
git tag -a v3.2.0 -m "v3.2.0: Saga Orchestrator"
```

### 상세 구현 가이드

#### 3.2.0.1 Saga 오케스트레이터
```java
// saga/Saga.java
public interface Saga<T> {
    String getSagaId();
    SagaState getState();
    List<SagaStep<T>> getSteps();
    T getContext();
}

// saga/SagaStep.java
public interface SagaStep<T> {
    String getStepName();
    Mono<StepResult> execute(T context);
    Mono<Void> compensate(T context);
}

// saga/CreateOrderSaga.java
@Component
@RequiredArgsConstructor
public class CreateOrderSaga implements Saga<OrderContext> {
    
    private final ProductGrpcClient productClient;
    private final PaymentService paymentService;
    private final ShippingService shippingService;
    
    @Override
    public List<SagaStep<OrderContext>> getSteps() {
        return List.of(
            new ReserveStockStep(productClient),
            new ProcessPaymentStep(paymentService),
            new CreateShipmentStep(shippingService)
        );
    }
}

// saga/steps/ReserveStockStep.java
@RequiredArgsConstructor
public class ReserveStockStep implements SagaStep<OrderContext> {
    
    private final ProductGrpcClient productClient;
    
    @Override
    public String getStepName() {
        return "RESERVE_STOCK";
    }
    
    @Override
    public Mono<StepResult> execute(OrderContext context) {
        return Flux.fromIterable(context.getOrderItems())
                .flatMap(item -> productClient.reserveStock(
                        item.getProductId(),
                        item.getQuantity(),
                        context.getOrderId()))
                .all(ReservationResponse::getSuccess)
                .map(success -> success 
                        ? StepResult.success() 
                        : StepResult.failure("Stock reservation failed"));
    }
    
    @Override
    public Mono<Void> compensate(OrderContext context) {
        return Flux.fromIterable(context.getReservationIds())
                .flatMap(productClient::releaseStock)
                .then();
    }
}

// saga/SagaOrchestrator.java
@Service
@RequiredArgsConstructor
@Slf4j
public class SagaOrchestrator {
    
    private final SagaStateRepository stateRepository;
    private final ApplicationEventPublisher eventPublisher;
    
    public <T> Mono<SagaResult> executeSaga(Saga<T> saga) {
        String sagaId = saga.getSagaId();
        T context = saga.getContext();
        List<SagaStep<T>> steps = saga.getSteps();
        
        return executeSteps(sagaId, context, steps, 0, new ArrayList<>())
                .doOnSuccess(result -> log.info("Saga {} completed: {}", sagaId, result))
                .doOnError(error -> log.error("Saga {} failed", sagaId, error));
    }
    
    private <T> Mono<SagaResult> executeSteps(
            String sagaId, 
            T context, 
            List<SagaStep<T>> steps, 
            int currentIndex,
            List<SagaStep<T>> executedSteps) {
        
        if (currentIndex >= steps.size()) {
            return Mono.just(SagaResult.completed(sagaId));
        }
        
        SagaStep<T> currentStep = steps.get(currentIndex);
        
        return saveState(sagaId, currentStep.getStepName(), StepStatus.EXECUTING)
                .then(currentStep.execute(context))
                .flatMap(result -> {
                    if (result.isSuccess()) {
                        executedSteps.add(currentStep);
                        return saveState(sagaId, currentStep.getStepName(), StepStatus.COMPLETED)
                                .then(executeSteps(sagaId, context, steps, currentIndex + 1, executedSteps));
                    } else {
                        return compensate(sagaId, context, executedSteps)
                                .then(Mono.just(SagaResult.failed(sagaId, result.getError())));
                    }
                })
                .onErrorResume(error -> 
                    compensate(sagaId, context, executedSteps)
                        .then(Mono.just(SagaResult.failed(sagaId, error.getMessage())))
                );
    }
    
    private <T> Mono<Void> compensate(String sagaId, T context, List<SagaStep<T>> executedSteps) {
        log.info("Compensating saga {}, {} steps to rollback", sagaId, executedSteps.size());
        
        return Flux.fromIterable(executedSteps)
                .reverse()
                .concatMap(step -> {
                    log.info("Compensating step: {}", step.getStepName());
                    return saveState(sagaId, step.getStepName(), StepStatus.COMPENSATING)
                            .then(step.compensate(context))
                            .then(saveState(sagaId, step.getStepName(), StepStatus.COMPENSATED));
                })
                .then();
    }
}
```

---

## v3.2.1: 보상 트랜잭션

### 작업 내용
| 순서 | 작업 | 핵심 파일 |
|------|------|----------|
| 3.2.1.1 | 재고 롤백 | `steps/ReserveStockStep.java` |
| 3.2.1.2 | 결제 환불 | `steps/ProcessPaymentStep.java` |
| 3.2.1.3 | 배송 취소 | `steps/CreateShipmentStep.java` |

### 커밋 포인트
```bash
git commit -m "feat(saga): add stock release compensation"
git commit -m "feat(saga): add payment refund compensation"
git commit -m "feat(saga): add shipment cancellation compensation"
git tag -a v3.2.1 -m "v3.2.1: Compensation Transactions"
```

---

## v3.2.2: Kafka 이벤트 통합

### 작업 내용
| 순서 | 작업 | 핵심 파일 |
|------|------|----------|
| 3.2.2.1 | Kafka 설정 | `KafkaConfig.java` |
| 3.2.2.2 | 이벤트 발행 | `SagaEventPublisher.java` |
| 3.2.2.3 | 이벤트 소비 | `SagaEventConsumer.java` |

### 커밋 포인트
```bash
git commit -m "infra(kafka): configure Kafka for saga events"
git commit -m "feat(saga): add saga event publisher"
git commit -m "feat(saga): add saga event consumer"
git tag -a v3.2.2 -m "v3.2.2: Saga Pattern Complete"
```

## 파일 구조

```
spring-patterns/
└── order-service/
    └── src/main/java/
        └── saga/
            ├── Saga.java
            ├── SagaStep.java
            ├── SagaOrchestrator.java
            ├── SagaStateRepository.java
            ├── CreateOrderSaga.java
            └── steps/
                ├── ReserveStockStep.java
                ├── ProcessPaymentStep.java
                └── CreateShipmentStep.java
```

## Saga 플로우

```
주문 생성 요청
      │
      ▼
┌─────────────┐
│ 재고 예약    │ ──실패──▶ 롤백 없음 (첫 단계)
└──────┬──────┘
       │ 성공
       ▼
┌─────────────┐
│ 결제 처리    │ ──실패──▶ 재고 예약 취소
└──────┬──────┘
       │ 성공
       ▼
┌─────────────┐
│ 배송 생성    │ ──실패──▶ 결제 환불 → 재고 예약 취소
└──────┬──────┘
       │ 성공
       ▼
   주문 완료
```
```

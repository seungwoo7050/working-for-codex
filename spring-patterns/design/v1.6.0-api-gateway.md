# Spring Cloud Gateway 설계 일지 (v1.6.0)
> 모놀리스 앞에 API Gateway를 추가하여 라우팅, 필터링, CORS 처리를 중앙화

## 1. 문제 정의 & 요구사항

### 1.1 목표

v1.5.0까지 구축한 모놀리스 애플리케이션 앞에 **API Gateway**를 추가한다:
- 클라이언트 요청을 백엔드로 라우팅
- 공통 관심사(로깅, CORS, 인증)를 Gateway에서 처리
- 향후 마이크로서비스 분리 대비

### 1.2 기능 요구사항

#### 1.2.1 Gateway 모듈 분리

**문제:**
- Spring Cloud Gateway는 **WebFlux** 기반
- 기존 애플리케이션은 **Spring MVC** 기반
- 같은 프로젝트에서 WebFlux와 MVC 공존 불가

**요구사항:**
1. **별도 모듈(gateway/)로 분리**
   - 멀티 모듈 Gradle 프로젝트 구성
   - 기존 백엔드는 `backend/` 또는 루트에 유지
   - Gateway는 `gateway/` 모듈로 분리

2. **의존성**
   - Spring Cloud Gateway
   - Spring Boot WebFlux (자동 포함)

#### 1.2.2 라우팅 규칙

**요구사항:**
1. **기본 라우팅**
   ```yaml
   /api/** → http://backend:8080/api/**
   ```

2. **Health Check 라우팅**
   ```yaml
   /health → http://backend:8080/api/health
   ```

3. **라우팅 옵션**
   - Path 기반 라우팅
   - 로드밸런서 미사용 (단일 백엔드)
   - 경로 재작성 불필요

#### 1.2.3 공통 필터

**요구사항:**
1. **로깅 필터**
   - 모든 요청/응답 로깅
   - 요청 ID 생성 및 전파

2. **CORS 필터**
   - 백엔드의 @CrossOrigin 제거
   - Gateway에서 CORS 일괄 처리

3. **향후 확장 (v1.7+)**
   - Rate Limiting
   - Circuit Breaker
   - JWT 검증

#### 1.2.4 Docker Compose 통합

**요구사항:**
- Gateway 서비스 추가
- 포트 매핑: Gateway(8081), Backend(8080 internal)
- 외부 노출은 Gateway만

### 1.3 비기능 요구사항

#### 1.3.1 성능
- Gateway 추가 지연 < 10ms
- 비동기 처리 (WebFlux)

#### 1.3.2 가용성
- Gateway 재시작 시 백엔드 영향 없음
- Health Check 엔드포인트 제공

---

## 2. 기술적 배경 & 설계 동기

### 2.1 왜 Spring Cloud Gateway인가?

**대안 비교:**
| 항목 | Spring Cloud Gateway | Nginx | Kong |
|------|----------------------|-------|------|
| 프로그래밍 | Java/Kotlin | 설정 파일 | Lua/설정 |
| 리액티브 | ✅ WebFlux | ❌ | ❌ |
| Spring 통합 | ✅ 네이티브 | ❌ | ❌ |
| 필터 커스텀 | ✅ Java 코드 | △ Lua | △ 플러그인 |
| 학습 목적 | ✅ Spring 생태계 | - | - |

**선택 이유:**
- Spring Boot 기반 프로젝트와 자연스러운 통합
- Java 코드로 복잡한 필터 로직 구현 가능
- 리액티브 스택으로 고성능

### 2.2 멀티 모듈 vs 별도 프로젝트

**멀티 모듈 장점:**
- 공통 설정/의존성 공유
- 하나의 저장소에서 관리
- Gradle 버전 관리 통합

**별도 프로젝트 장점:**
- 완전한 분리
- 독립 배포 가능

**결정: 별도 디렉터리로 분리 (같은 저장소)**
- 학습 목적상 단순하게 유지
- `gateway/` 디렉터리에 독립적인 Gradle 프로젝트

---

## 3. 상세 설계

### 3.1 프로젝트 구조

```
spring-patterns/
├── build.gradle              # 백엔드 (기존)
├── settings.gradle           # 백엔드
├── src/                      # 백엔드 소스
├── gateway/                  # Gateway 모듈
│   ├── build.gradle
│   ├── settings.gradle
│   ├── src/
│   │   └── main/
│   │       ├── java/
│   │       │   └── com/example/gateway/
│   │       │       ├── GatewayApplication.java
│   │       │       ├── config/
│   │       │       │   ├── GatewayConfig.java
│   │       │       │   └── CorsConfig.java
│   │       │       └── filter/
│   │       │           └── LoggingFilter.java
│   │       └── resources/
│   │           └── application.yml
│   └── Dockerfile
└── docker-compose.yml        # Gateway 서비스 추가
```

### 3.2 Gateway 의존성 (gateway/build.gradle)

```groovy
plugins {
    id 'java'
    id 'org.springframework.boot' version '3.3.5'
    id 'io.spring.dependency-management' version '1.1.6'
}

ext {
    set('springCloudVersion', "2023.0.3")
}

dependencies {
    implementation 'org.springframework.cloud:spring-cloud-starter-gateway'
    testImplementation 'org.springframework.boot:spring-boot-starter-test'
}

dependencyManagement {
    imports {
        mavenBom "org.springframework.cloud:spring-cloud-dependencies:${springCloudVersion}"
    }
}
```

### 3.3 라우팅 설정 (application.yml)

```yaml
server:
  port: 8081

spring:
  application:
    name: api-gateway
    
  cloud:
    gateway:
      routes:
        - id: backend-api
          uri: http://${BACKEND_HOST:localhost}:${BACKEND_PORT:8080}
          predicates:
            - Path=/api/**
          filters:
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 10
                redis-rate-limiter.burstCapacity: 20
              # (선택) Rate Limiter는 Redis 필요
            
        - id: backend-health
          uri: http://${BACKEND_HOST:localhost}:${BACKEND_PORT:8080}
          predicates:
            - Path=/health
          filters:
            - RewritePath=/health, /api/health
```

### 3.4 로깅 필터

```java
@Component
@Slf4j
public class LoggingFilter implements GlobalFilter, Ordered {

    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        String requestId = UUID.randomUUID().toString().substring(0, 8);
        long startTime = System.currentTimeMillis();
        
        ServerHttpRequest request = exchange.getRequest();
        log.info("[{}] >> {} {}", requestId, request.getMethod(), request.getURI());
        
        return chain.filter(exchange)
            .doOnSuccess(v -> {
                long duration = System.currentTimeMillis() - startTime;
                log.info("[{}] << {} ({}ms)", 
                    requestId, 
                    exchange.getResponse().getStatusCode(),
                    duration);
            });
    }

    @Override
    public int getOrder() {
        return -1; // 높은 우선순위
    }
}
```

### 3.5 CORS 설정

```java
@Configuration
public class CorsConfig {

    @Bean
    public CorsWebFilter corsWebFilter() {
        CorsConfiguration config = new CorsConfiguration();
        config.setAllowedOrigins(List.of("http://localhost:3000", "http://localhost:5173"));
        config.setAllowedMethods(List.of("GET", "POST", "PUT", "DELETE", "OPTIONS"));
        config.setAllowedHeaders(List.of("*"));
        config.setAllowCredentials(true);
        config.setMaxAge(3600L);
        
        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
        source.registerCorsConfiguration("/**", config);
        
        return new CorsWebFilter(source);
    }
}
```

---

## 4. Docker Compose 통합

### 4.1 Gateway 서비스 추가

```yaml
services:
  # API Gateway
  gateway:
    build: ./gateway
    container_name: spring-gateway
    depends_on:
      - app
    environment:
      BACKEND_HOST: app
      BACKEND_PORT: 8080
    ports:
      - "8081:8081"
    networks:
      - app-network
    restart: unless-stopped

  # Spring Boot Backend (기존)
  app:
    build: .
    container_name: spring-training-app
    # ports 제거: 외부 노출 안 함 (Gateway 통해서만 접근)
    expose:
      - "8080"
    ...
```

### 4.2 포트 매핑 변경

```
변경 전:
  Client → localhost:8080 → Backend

변경 후:
  Client → localhost:8081 → Gateway → app:8080 → Backend
```

---

## 5. 테스트 시나리오

### 5.1 단위 테스트

1. **라우팅 테스트**
   - `/api/health` → 200 OK
   - `/api/issues` → 백엔드 응답

2. **필터 테스트**
   - 로깅 필터 동작 확인
   - CORS 헤더 확인

### 5.2 통합 테스트

```bash
# 1. Docker Compose로 전체 스택 실행
docker-compose up -d

# 2. Gateway 통해 헬스체크
curl http://localhost:8081/api/health

# 3. Gateway 통해 API 호출
curl http://localhost:8081/api/issues

# 4. CORS 확인
curl -H "Origin: http://localhost:3000" \
     -H "Access-Control-Request-Method: GET" \
     -X OPTIONS \
     http://localhost:8081/api/health -v
```

---

## 6. 마이그레이션 가이드

### 6.1 기존 코드 변경사항

**제거해야 할 것:**
- 백엔드 Controller의 `@CrossOrigin` 어노테이션

**유지해야 할 것:**
- 모든 비즈니스 로직
- JWT 인증 (백엔드에서 유지, 선택적으로 Gateway로 이동 가능)

### 6.2 클라이언트 변경

```javascript
// 변경 전
const API_URL = 'http://localhost:8080/api';

// 변경 후
const API_URL = 'http://localhost:8081/api';
```

---

## 7. 확장 계획 (v1.7+)

### 7.1 Rate Limiting

```yaml
spring.cloud.gateway.routes[0].filters:
  - name: RequestRateLimiter
    args:
      redis-rate-limiter.replenishRate: 10
      redis-rate-limiter.burstCapacity: 20
```

### 7.2 Circuit Breaker

```yaml
spring.cloud.gateway.routes[0].filters:
  - name: CircuitBreaker
    args:
      name: backendCircuitBreaker
      fallbackUri: forward:/fallback
```

### 7.3 JWT 검증 Gateway 이동

```java
@Component
public class JwtAuthFilter implements GlobalFilter {
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        String token = exchange.getRequest().getHeaders().getFirst("Authorization");
        if (!validateToken(token)) {
            exchange.getResponse().setStatusCode(HttpStatus.UNAUTHORIZED);
            return exchange.getResponse().setComplete();
        }
        return chain.filter(exchange);
    }
}
```

---

## 8. 참고 자료

- [Spring Cloud Gateway 공식 문서](https://docs.spring.io/spring-cloud-gateway/)
- [Spring Cloud Gateway Reference](https://cloud.spring.io/spring-cloud-gateway/reference/html/)
- [API Gateway 패턴 - Microsoft](https://docs.microsoft.com/en-us/azure/architecture/microservices/design/gateway)

```markdown
# CLAUDE.md - spring-patterns v2.4 성능 최적화

> AI 코딩 에이전트를 위한 프로젝트 컨텍스트 가이드 (미드 레벨)

## 프로젝트 개요

### 선행 조건
- v2.0.0 ~ v2.3.0 모두 완료
- WebFlux, Virtual Threads, Rate Limiting, Caching 구현

### 현재 상태 (v2.3.0)
- Redis 캐싱
- Gzip 압축
- Rate Limiting

### 목표 상태 (v2.4.0)
- **성능 최적화 & 벤치마크**
- 연결 풀 최적화
- 10K req/s 달성

## 버전 로드맵 (v2.4 세부화)

| 버전 | 기간 | 설명 |
|------|------|------|
| v2.4.0 | 1주 | 성능 최적화 & 벤치마크 |

---

## v2.4.0: 성능 최적화 & 벤치마크

### 작업 내용
| 순서 | 작업 | 핵심 파일 |
|------|------|----------|
| 2.4.0.1 | R2DBC 연결 풀 최적화 | `application.yml` |
| 2.4.0.2 | Redis 연결 풀 최적화 | `RedisConfig.java` |
| 2.4.0.3 | 벤치마크 스크립트 | `scripts/benchmark.sh` |
| 2.4.0.4 | 성능 문서화 | `docs/PERFORMANCE.md` |

### 커밋 포인트
```bash
git commit -m "perf(config): optimize R2DBC connection pool settings"
git commit -m "perf(config): optimize Redis connection pool"
git commit -m "test(bench): add wrk benchmark scripts"
git commit -m "docs: add performance benchmark results"
git tag -a v2.4.0 -m "v2.4.0: Performance Optimization Complete"
```

### 상세 구현 가이드

#### 2.4.0.1 연결 풀 최적화
```yaml
# application.yml
spring:
  r2dbc:
    url: r2dbc:postgresql://localhost:5432/spring_patterns
    pool:
      enabled: true
      initial-size: 10
      max-size: 50
      max-idle-time: 30m
      max-life-time: 60m
      acquire-retry: 3
      validation-query: SELECT 1

  data:
    redis:
      host: localhost
      port: 6379
      lettuce:
        pool:
          min-idle: 10
          max-idle: 50
          max-active: 100
          max-wait: 2000ms
        shutdown-timeout: 100ms

# Netty 최적화
server:
  netty:
    connection-timeout: 5s
    h2c-max-content-length: 0
    initial-buffer-size: 128
    max-keep-alive-requests: 200
```

#### 2.4.0.2 Redis 연결 풀 최적화
```java
// RedisConfig.java
@Configuration
public class RedisConfig {
    
    @Bean
    public LettuceConnectionFactory redisConnectionFactory(RedisProperties properties) {
        LettucePoolingClientConfiguration poolConfig = LettucePoolingClientConfiguration.builder()
                .poolConfig(genericObjectPoolConfig())
                .commandTimeout(Duration.ofMillis(500))
                .build();
        
        RedisStandaloneConfiguration serverConfig = new RedisStandaloneConfiguration(
                properties.getHost(), properties.getPort());
        
        return new LettuceConnectionFactory(serverConfig, poolConfig);
    }
    
    @Bean
    public GenericObjectPoolConfig<?> genericObjectPoolConfig() {
        GenericObjectPoolConfig<?> config = new GenericObjectPoolConfig<>();
        config.setMinIdle(10);
        config.setMaxIdle(50);
        config.setMaxTotal(100);
        config.setMaxWait(Duration.ofMillis(2000));
        config.setTestOnBorrow(true);
        config.setTestWhileIdle(true);
        config.setTimeBetweenEvictionRuns(Duration.ofSeconds(30));
        return config;
    }
}
```

#### 2.4.0.3 벤치마크 스크립트
```bash
#!/bin/bash
# scripts/benchmark.sh

# 기본 읽기 테스트
echo "=== Read Performance Test ==="
wrk -t12 -c400 -d30s http://localhost:8080/api/v2/products

# 쓰기 테스트
echo "=== Write Performance Test ==="
wrk -t8 -c200 -d30s -s post_product.lua http://localhost:8080/api/v2/products

# SSE 스트리밍 테스트
echo "=== SSE Streaming Test ==="
wrk -t4 -c100 -d30s http://localhost:8080/api/v2/products/stream

# 연결 수별 테스트
for connections in 100 200 400 800 1000; do
    echo "=== Testing with $connections connections ==="
    wrk -t12 -c$connections -d10s http://localhost:8080/api/v2/products
done
```

#### 2.4.0.4 성능 문서화
```markdown
# PERFORMANCE.md

## 벤치마크 환경
- **서버**: AWS c5.2xlarge (8 vCPU, 16GB RAM)
- **데이터베이스**: PostgreSQL 15 (db.r6g.large)
- **Redis**: Redis 7.0 (cache.r6g.large)
- **로드 테스트**: wrk 4.1.0

## 결과

### 읽기 성능 (GET /api/v2/products)
| 동시 연결 | Req/s | 평균 지연 | P99 지연 |
|----------|-------|----------|---------|
| 100 | 8,500 | 11.7ms | 45ms |
| 200 | 10,200 | 19.6ms | 78ms |
| 400 | 10,800 | 37.0ms | 156ms |
| 800 | 10,500 | 76.1ms | 312ms |

### 쓰기 성능 (POST /api/v2/products)
| 동시 연결 | Req/s | 평균 지연 | P99 지연 |
|----------|-------|----------|---------|
| 100 | 4,200 | 23.8ms | 89ms |
| 200 | 5,100 | 39.2ms | 145ms |

### 캐시 히트율
- **상품 상세**: 94.2%
- **상품 목록**: 87.5%

### 리소스 사용률
- **CPU**: 평균 65%, 피크 82%
- **메모리**: 평균 4.2GB, 피크 5.8GB
- **DB 연결**: 평균 35/50, 피크 48/50
```

## 파일 구조

```
spring-patterns/
├── src/main/
│   ├── java/
│   │   └── config/
│   │       └── RedisConfig.java
│   └── resources/
│       └── application.yml
├── scripts/
│   ├── benchmark.sh
│   └── post_product.lua
└── docs/
    └── PERFORMANCE.md
```

## 성능 목표 달성

| 메트릭 | 목표 | 달성 |
|--------|------|------|
| 읽기 처리량 | 10K req/s | ✅ 10.8K |
| 쓰기 처리량 | 5K req/s | ✅ 5.1K |
| P99 지연 (읽기) | < 200ms | ✅ 156ms |
| 캐시 히트율 | > 85% | ✅ 94.2% |
```

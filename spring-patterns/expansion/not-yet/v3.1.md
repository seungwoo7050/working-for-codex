```markdown
# CLAUDE.md - spring-patterns v3.1 gRPC 서비스 간 통신

> AI 코딩 에이전트를 위한 프로젝트 컨텍스트 가이드 (시니어 레벨)

## 프로젝트 개요

### 선행 조건
- v3.0.0 마이크로서비스 분리 완료
- API Gateway 구현 완료

### 현재 상태 (v3.0.0)
- Product/Order/User 서비스 분리
- Spring Cloud Gateway
- Consul 서비스 디스커버리

### 목표 상태 (v3.1.0)
- **gRPC 서비스 간 통신**
- Protobuf 스키마
- gRPC 스트리밍

## 버전 로드맵 (v3.1 세부화)

| 버전 | 기간 | 설명 |
|------|------|------|
| v3.1.0 | 0.5주 | Protobuf 스키마 정의 |
| v3.1.1 | 0.5주 | gRPC Server 구현 |
| v3.1.2 | 0.5주 | gRPC Client 구현 |
| v3.1.3 | 0.5주 | 스트리밍 API |

---

## v3.1.0: Protobuf 스키마 정의

### 작업 내용
| 순서 | 작업 | 핵심 파일 |
|------|------|----------|
| 3.1.0.1 | Product 스키마 | `proto/product.proto` |
| 3.1.0.2 | Order 스키마 | `proto/order.proto` |
| 3.1.0.3 | Common 타입 | `proto/common.proto` |
| 3.1.0.4 | Gradle 플러그인 | `build.gradle` |

### 커밋 포인트
```bash
git commit -m "feat(proto): define Protobuf schema for product service"
git commit -m "feat(proto): define Protobuf schema for order service"
git commit -m "feat(proto): add common types and messages"
git commit -m "build: configure protobuf Gradle plugin"
git tag -a v3.1.0 -m "v3.1.0: Protobuf Schema"
```

### 상세 구현 가이드

#### 3.1.0.1 Protobuf 스키마
```protobuf
// proto/product.proto
syntax = "proto3";
package product;

option java_multiple_files = true;
option java_package = "com.example.grpc.product";

import "google/protobuf/timestamp.proto";
import "common.proto";

service ProductService {
    rpc GetProduct (GetProductRequest) returns (ProductResponse);
    rpc GetProducts (GetProductsRequest) returns (stream ProductResponse);
    rpc CheckStock (CheckStockRequest) returns (StockResponse);
    rpc ReserveStock (ReserveStockRequest) returns (ReservationResponse);
    rpc ReleaseStock (ReleaseStockRequest) returns (common.Empty);
}

message GetProductRequest {
    int64 product_id = 1;
}

message GetProductsRequest {
    repeated int64 product_ids = 1;
    optional string category = 2;
    int32 page = 3;
    int32 size = 4;
}

message ProductResponse {
    int64 id = 1;
    string name = 2;
    string description = 3;
    int32 price = 4;
    int32 stock = 5;
    string category = 6;
    google.protobuf.Timestamp created_at = 7;
}

message CheckStockRequest {
    int64 product_id = 1;
    int32 quantity = 2;
}

message StockResponse {
    bool available = 1;
    int32 current_stock = 2;
}

message ReserveStockRequest {
    int64 product_id = 1;
    int32 quantity = 2;
    string order_id = 3;
}

message ReservationResponse {
    bool success = 1;
    string reservation_id = 2;
    string message = 3;
}

message ReleaseStockRequest {
    string reservation_id = 1;
}
```

---

## v3.1.1: gRPC Server 구현

### 작업 내용
| 순서 | 작업 | 핵심 파일 |
|------|------|----------|
| 3.1.1.1 | gRPC 설정 | `GrpcServerConfig.java` |
| 3.1.1.2 | ProductGrpcService | `ProductGrpcService.java` |
| 3.1.1.3 | 에러 핸들링 | `GrpcExceptionHandler.java` |
| 3.1.1.4 | 인터셉터 | `AuthInterceptor.java` |

### 커밋 포인트
```bash
git commit -m "feat(grpc): configure gRPC server"
git commit -m "feat(grpc): implement ProductGrpcService"
git commit -m "feat(grpc): add error handling for gRPC"
git commit -m "feat(grpc): add authentication interceptor"
git tag -a v3.1.1 -m "v3.1.1: gRPC Server"
```

### 상세 구현 가이드

#### 3.1.1.1 gRPC 서버 구현
```java
// ProductGrpcService.java
@GrpcService
@RequiredArgsConstructor
public class ProductGrpcService extends ProductServiceGrpc.ProductServiceImplBase {
    
    private final ProductService productService;
    private final StockService stockService;
    
    @Override
    public void getProduct(GetProductRequest request, 
                          StreamObserver<ProductResponse> responseObserver) {
        
        productService.findById(request.getProductId())
                .map(this::toProto)
                .subscribe(
                        response -> {
                            responseObserver.onNext(response);
                            responseObserver.onCompleted();
                        },
                        error -> responseObserver.onError(
                            Status.NOT_FOUND
                                .withDescription("Product not found")
                                .asRuntimeException()
                        )
                );
    }
    
    @Override
    public void reserveStock(ReserveStockRequest request,
                            StreamObserver<ReservationResponse> responseObserver) {
        
        stockService.reserve(
                request.getProductId(),
                request.getQuantity(),
                request.getOrderId()
        )
        .subscribe(
                reservation -> {
                    responseObserver.onNext(ReservationResponse.newBuilder()
                            .setSuccess(true)
                            .setReservationId(reservation.getId())
                            .build());
                    responseObserver.onCompleted();
                },
                error -> {
                    responseObserver.onNext(ReservationResponse.newBuilder()
                            .setSuccess(false)
                            .setMessage(error.getMessage())
                            .build());
                    responseObserver.onCompleted();
                }
        );
    }
    
    private ProductResponse toProto(Product product) {
        return ProductResponse.newBuilder()
                .setId(product.getId())
                .setName(product.getName())
                .setDescription(product.getDescription())
                .setPrice(product.getPrice())
                .setStock(product.getStock())
                .setCategory(product.getCategory())
                .build();
    }
}
```

---

## v3.1.2: gRPC Client 구현

### 작업 내용
| 순서 | 작업 | 핵심 파일 |
|------|------|----------|
| 3.1.2.1 | 클라이언트 설정 | `GrpcClientConfig.java` |
| 3.1.2.2 | ProductGrpcClient | `ProductGrpcClient.java` |
| 3.1.2.3 | 재시도 정책 | `RetryPolicy.java` |
| 3.1.2.4 | 로드 밸런싱 | `application.yml` |

### 커밋 포인트
```bash
git commit -m "feat(grpc): configure gRPC client"
git commit -m "feat(grpc): implement ProductGrpcClient"
git commit -m "feat(grpc): add retry policy for gRPC calls"
git commit -m "feat(grpc): add client-side load balancing"
git tag -a v3.1.2 -m "v3.1.2: gRPC Client"
```

### 상세 구현 가이드

#### 3.1.2.1 gRPC 클라이언트
```java
// ProductGrpcClient.java
@Component
@RequiredArgsConstructor
public class ProductGrpcClient {
    
    @GrpcClient("product-service")
    private ProductServiceGrpc.ProductServiceBlockingStub blockingStub;
    
    @GrpcClient("product-service")
    private ProductServiceGrpc.ProductServiceStub asyncStub;
    
    public ProductResponse getProduct(Long productId) {
        try {
            return blockingStub.getProduct(
                    GetProductRequest.newBuilder()
                            .setProductId(productId)
                            .build()
            );
        } catch (StatusRuntimeException e) {
            throw new ProductServiceException("Failed to get product", e);
        }
    }
    
    public Flux<ProductResponse> getProducts(List<Long> productIds) {
        return Flux.create(sink -> {
            asyncStub.getProducts(
                    GetProductsRequest.newBuilder()
                            .addAllProductIds(productIds)
                            .build(),
                    new StreamObserver<ProductResponse>() {
                        @Override
                        public void onNext(ProductResponse response) {
                            sink.next(response);
                        }
                        
                        @Override
                        public void onError(Throwable t) {
                            sink.error(t);
                        }
                        
                        @Override
                        public void onCompleted() {
                            sink.complete();
                        }
                    }
            );
        });
    }
}
```

---

## v3.1.3: 스트리밍 API

### 작업 내용
| 순서 | 작업 | 핵심 파일 |
|------|------|----------|
| 3.1.3.1 | Server Streaming | `ProductGrpcService.java` |
| 3.1.3.2 | Bidirectional | `ChatGrpcService.java` |
| 3.1.3.3 | 흐름 제어 | `FlowControl.java` |

### 커밋 포인트
```bash
git commit -m "feat(grpc): add server-side streaming for product list"
git commit -m "feat(grpc): add bidirectional streaming example"
git commit -m "feat(grpc): add flow control for streaming"
git tag -a v3.1.3 -m "v3.1.3: gRPC Streaming Complete"
```

## 파일 구조

```
spring-patterns/
├── proto/
│   ├── product.proto
│   ├── order.proto
│   └── common.proto
├── product-service/
│   └── src/main/java/
│       └── grpc/
│           ├── ProductGrpcService.java
│           └── GrpcExceptionHandler.java
└── order-service/
    └── src/main/java/
        └── client/
            └── ProductGrpcClient.java
```

## gRPC vs REST 비교

| 항목 | REST | gRPC |
|------|------|------|
| 프로토콜 | HTTP/1.1 | HTTP/2 |
| 직렬화 | JSON | Protobuf |
| 타입 안전성 | 낮음 | 높음 (스키마) |
| 스트리밍 | 제한적 | 네이티브 지원 |
| 지연 시간 | 높음 | 낮음 |
```

```markdown
# CLAUDE.md - spring-patterns v3.4 커스텀 메트릭 & 로깅

> AI 코딩 에이전트를 위한 프로젝트 컨텍스트 가이드 (시니어 레벨)

## 프로젝트 개요

### 선행 조건
- v3.0.0 ~ v3.3.0 완료
- OpenTelemetry 분산 추적 구현

### 현재 상태 (v3.3.0)
- OpenTelemetry SDK
- Jaeger 시각화
- 커스텀 스팬

### 목표 상태 (v3.4.0)
- **커스텀 메트릭 & 로깅**
- 비즈니스 메트릭
- 분산 로깅

## 버전 로드맵 (v3.4 세부화)

| 버전 | 기간 | 설명 |
|------|------|------|
| v3.4.0 | 0.5주 | 비즈니스 메트릭 |
| v3.4.1 | 0.5주 | 분산 로깅 |
| v3.4.2 | 0.5주 | Grafana 대시보드 |

---

## v3.4.0: 비즈니스 메트릭

### 작업 내용
| 순서 | 작업 | 핵심 파일 |
|------|------|----------|
| 3.4.0.1 | BusinessMetrics | `metrics/BusinessMetrics.java` |
| 3.4.0.2 | 주문 처리 타이머 | `BusinessMetrics.java` |
| 3.4.0.3 | 재고 게이지 | `BusinessMetrics.java` |
| 3.4.0.4 | 카운터 적용 | `OrderService.java` |

### 커밋 포인트
```bash
git commit -m "feat(metrics): implement business metrics with Micrometer"
git commit -m "feat(metrics): add order processing timer"
git commit -m "feat(metrics): add stock level gauge"
git commit -m "feat(metrics): apply counters to business operations"
git tag -a v3.4.0 -m "v3.4.0: Business Metrics"
```

### 상세 구현 가이드

#### 3.4.0.1 비즈니스 메트릭
```java
// metrics/BusinessMetrics.java
@Component
@RequiredArgsConstructor
public class BusinessMetrics {
    
    private final MeterRegistry registry;
    
    // 카운터
    private Counter ordersCreated;
    private Counter ordersCompleted;
    private Counter ordersFailed;
    private Counter paymentsProcessed;
    
    // 타이머
    private Timer orderProcessingTimer;
    private Timer paymentProcessingTimer;
    
    // 게이지
    private AtomicInteger activeOrders = new AtomicInteger(0);
    
    @PostConstruct
    public void init() {
        // 주문 카운터
        ordersCreated = Counter.builder("orders.created")
                .description("Total orders created")
                .tag("service", "order-service")
                .register(registry);
        
        ordersCompleted = Counter.builder("orders.completed")
                .description("Total orders completed")
                .tag("service", "order-service")
                .register(registry);
        
        ordersFailed = Counter.builder("orders.failed")
                .description("Total orders failed")
                .tag("service", "order-service")
                .register(registry);
        
        // 주문 처리 시간
        orderProcessingTimer = Timer.builder("orders.processing.time")
                .description("Time to process an order")
                .publishPercentiles(0.5, 0.95, 0.99)
                .publishPercentileHistogram()
                .register(registry);
        
        // 활성 주문 수 (게이지)
        Gauge.builder("orders.active", activeOrders, AtomicInteger::get)
                .description("Current active orders")
                .register(registry);
    }
    
    public void recordOrderCreated() {
        ordersCreated.increment();
        activeOrders.incrementAndGet();
    }
    
    public void recordOrderCompleted() {
        ordersCompleted.increment();
        activeOrders.decrementAndGet();
    }
    
    public void recordOrderFailed(String reason) {
        ordersFailed.increment();
        activeOrders.decrementAndGet();
        
        Counter.builder("orders.failed.by.reason")
                .tag("reason", reason)
                .register(registry)
                .increment();
    }
    
    public Timer.Sample startOrderTimer() {
        return Timer.start(registry);
    }
    
    public void stopOrderTimer(Timer.Sample sample) {
        sample.stop(orderProcessingTimer);
    }
}

// OrderService.java 적용 예시
@Service
@RequiredArgsConstructor
public class OrderService {
    
    private final BusinessMetrics metrics;
    private final SagaOrchestrator sagaOrchestrator;
    
    public Mono<Order> createOrder(CreateOrderRequest request) {
        Timer.Sample sample = metrics.startOrderTimer();
        metrics.recordOrderCreated();
        
        return sagaOrchestrator.executeSaga(new CreateOrderSaga(request))
                .doOnSuccess(result -> {
                    metrics.stopOrderTimer(sample);
                    if (result.isCompleted()) {
                        metrics.recordOrderCompleted();
                    } else {
                        metrics.recordOrderFailed(result.getError());
                    }
                })
                .doOnError(error -> {
                    metrics.stopOrderTimer(sample);
                    metrics.recordOrderFailed(error.getMessage());
                });
    }
}
```

---

## v3.4.1: 분산 로깅

### 작업 내용
| 순서 | 작업 | 핵심 파일 |
|------|------|----------|
| 3.4.1.1 | MDC 통합 | `LoggingAspect.java` |
| 3.4.1.2 | Trace ID 로깅 | `logback-spring.xml` |
| 3.4.1.3 | 구조화된 로깅 | `StructuredLogger.java` |

### 커밋 포인트
```bash
git commit -m "feat(logging): add distributed logging with trace correlation"
git commit -m "feat(logging): add trace ID to log pattern"
git commit -m "feat(logging): add structured logging support"
git tag -a v3.4.1 -m "v3.4.1: Distributed Logging"
```

### 상세 구현 가이드

#### 3.4.1.1 분산 로깅
```xml
<!-- logback-spring.xml -->
<configuration>
    <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
        <encoder class="net.logstash.logback.encoder.LoggingEventCompositeJsonEncoder">
            <providers>
                <timestamp>
                    <pattern>yyyy-MM-dd'T'HH:mm:ss.SSSZ</pattern>
                </timestamp>
                <logLevel/>
                <loggerName/>
                <threadName/>
                <message/>
                <mdc/>
                <stackTrace/>
                <pattern>
                    <pattern>
                        {
                            "service": "${SERVICE_NAME:-unknown}",
                            "traceId": "%X{traceId:-}",
                            "spanId": "%X{spanId:-}"
                        }
                    </pattern>
                </pattern>
            </providers>
        </encoder>
    </appender>
    
    <root level="INFO">
        <appender-ref ref="CONSOLE"/>
    </root>
</configuration>
```

```java
// LoggingAspect.java
@Aspect
@Component
@Slf4j
public class LoggingAspect {
    
    @Around("@within(org.springframework.web.bind.annotation.RestController)")
    public Object logRequest(ProceedingJoinPoint joinPoint) throws Throwable {
        String traceId = Span.current().getSpanContext().getTraceId();
        MDC.put("traceId", traceId);
        
        String method = joinPoint.getSignature().getName();
        Object[] args = joinPoint.getArgs();
        
        log.info("Request: method={}, args={}", method, Arrays.toString(args));
        
        long startTime = System.currentTimeMillis();
        try {
            Object result = joinPoint.proceed();
            long duration = System.currentTimeMillis() - startTime;
            log.info("Response: method={}, duration={}ms", method, duration);
            return result;
        } catch (Exception e) {
            long duration = System.currentTimeMillis() - startTime;
            log.error("Error: method={}, duration={}ms, error={}", 
                    method, duration, e.getMessage());
            throw e;
        } finally {
            MDC.clear();
        }
    }
}
```

---

## v3.4.2: Grafana 대시보드

### 작업 내용
| 순서 | 작업 | 핵심 파일 |
|------|------|----------|
| 3.4.2.1 | Prometheus 설정 | `prometheus.yml` |
| 3.4.2.2 | Grafana 대시보드 | `grafana/dashboards/` |
| 3.4.2.3 | 알림 규칙 | `alerts.yml` |

### 커밋 포인트
```bash
git commit -m "infra(prometheus): configure Prometheus scraping"
git commit -m "infra(grafana): add Grafana dashboards for monitoring"
git commit -m "infra(alerts): add alerting rules"
git tag -a v3.4.2 -m "v3.4.2: Metrics & Logging Complete"
```

## 파일 구조

```
spring-patterns/
├── common/
│   ├── metrics/
│   │   └── BusinessMetrics.java
│   └── logging/
│       ├── LoggingAspect.java
│       └── StructuredLogger.java
├── monitoring/
│   ├── prometheus/
│   │   └── prometheus.yml
│   └── grafana/
│       └── dashboards/
│           ├── orders.json
│           └── system.json
└── src/main/resources/
    └── logback-spring.xml
```

## 핵심 메트릭

| 메트릭 | 유형 | 설명 |
|--------|------|------|
| orders.created | Counter | 생성된 주문 수 |
| orders.completed | Counter | 완료된 주문 수 |
| orders.failed | Counter | 실패한 주문 수 |
| orders.processing.time | Timer | 주문 처리 시간 |
| orders.active | Gauge | 현재 처리 중인 주문 |
```

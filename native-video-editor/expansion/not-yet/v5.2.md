# CLAUDE.md - native-video-editor v5.2 스트리밍 플랫폼 (DRM/CDN 통합)

> AI 코딩 에이전트를 위한 프로젝트 컨텍스트 가이드 (시니어 레벨)

## 프로젝트 개요

### 선행 조건
- v5.1.0 VOD 시스템 완료
- 분산 트랜스코딩 및 메타데이터 관리 가능

### 현재 상태 (v5.1.0)
- 대규모 VOD 시스템 구축
- 메타데이터 검색 및 클라우드 스토리지
- 트랜스코딩 클러스터 운영

### 목표 상태 (v5.2.0)
- **DRM 및 CDN 완전 통합**
- 멀티 DRM 시스템 지원
- 글로벌 CDN 배포 및 모니터링

## 구현할 기능

### Phase 3: DRM/CDN 통합 (Month 5-6)

#### 3.1 DRM 통합
```cpp
// DRMPackager.hpp
class DRMPackager {
public:
    enum class DRMSystem {
        WIDEVINE,
        FAIRPLAY,
        PLAYREADY,
        CLEARKEY  // 테스트용
    };

    struct DRMConfig {
        std::vector<DRMSystem> systems;
        std::string licenseServerUrl;
        std::string contentId;
        EncryptionMode mode = EncryptionMode::CENC;  // or CBCS
    };

    // DRM 패키징
    void package(
        const std::string& inputPath,
        const std::string& outputPath,
        const DRMConfig& config
    );

private:
    // 키 생성/관리
    struct ContentKey {
        std::array<uint8_t, 16> keyId;
        std::array<uint8_t, 16> key;
    };
    
    ContentKey generateKey(const std::string& contentId);
    
    // PSSH 박스 생성
    std::vector<uint8_t> createPSSH(DRMSystem system, const ContentKey& key);
    
    // 암호화
    void encryptContent(
        const std::string& inputPath,
        const std::string& outputPath,
        const ContentKey& key,
        EncryptionMode mode
    );
};

// 사용 예시
void packageForAllPlatforms(const std::string& videoPath) {
    DRMPackager packager;
    
    packager.package(videoPath, "output/", {
        .systems = {DRMSystem::WIDEVINE, DRMSystem::FAIRPLAY, DRMSystem::PLAYREADY},
        .licenseServerUrl = "https://license.example.com",
        .contentId = generateContentId(videoPath),
        .mode = EncryptionMode::CBCS  // Apple 호환
    });
}
```

#### 3.2 멀티 CDN 관리
```cpp
// CDNManager.hpp
class CDNManager {
public:
    struct CDNProvider {
        std::string name;           // "cloudflare", "akamai", "fastly"
        std::string originUrl;
        std::map<std::string, int> regionLatencies;  // 리전별 지연
        float costPerGB;
        bool isHealthy;
    };

    // CDN 선택 (지연, 비용, 가용성 기반)
    std::string selectCDN(
        const std::string& viewerRegion,
        ContentType type  // LIVE, VOD
    );
    
    // 콘텐츠 퍼지
    void purgeContent(const std::string& contentId);
    
    // 프리페치
    void prefetch(const std::string& contentId, const std::vector<std::string>& regions);
    
    // CDN 상태 모니터링
    std::vector<CDNHealth> getHealthStatus();

private:
    std::vector<CDNProvider> providers_;
    
    // 가중치 기반 라우팅
    CDNProvider selectByWeight(
        const std::vector<CDNProvider>& candidates,
        const std::function<float(const CDNProvider&)>& scorer
    );
};
```

#### 3.3 실시간 품질 모니터링
```cpp
// QualityMonitor.hpp
class QualityMonitor {
public:
    struct QualityMetrics {
        std::string sessionId;
        float bitrate;
        float bufferHealth;     // 버퍼 상태 (0-1)
        int droppedFrames;
        float avgLatency;       // ms
        std::string viewerRegion;
        TimePoint timestamp;
    };

    // 메트릭 수집
    void recordMetrics(const QualityMetrics& metrics);
    
    // 품질 분석
    QualityReport analyzeQuality(const std::string& sessionId, TimeRange range);
    
    // 실시간 알림
    void setQualityThresholds(const QualityThresholds& thresholds);
    
    // ABR 조정 제안
    ABRRecommendation suggestABR(const QualityMetrics& current);

private:
    // Prometheus/Grafana 통합
    std::unique_ptr<MetricsStore> store_;
    
    // 실시간 분석
    std::unique_ptr<QualityAnalyzer> analyzer_;
};
```

#### 3.4 글로벌 배포 시스템
```cpp
// GlobalDistribution.hpp
class GlobalDistribution {
public:
    struct DistributionConfig {
        std::vector<std::string> regions;     // "us-east", "eu-west", etc.
        std::vector<CDNProvider> cdns;
        ReplicationStrategy strategy;         // PUSH, PULL, HYBRID
        int replicaCount = 3;
    };

    // 콘텐츠 배포
    void distributeContent(
        const std::string& contentId,
        const DistributionConfig& config
    );
    
    // 지역별 최적 CDN 선택
    std::string getOptimalCDN(
        const std::string& contentId,
        const std::string& viewerRegion
    );

private:
    // 지역별 복제
    void replicateToRegion(
        const std::string& contentId,
        const std::string& region,
        const std::vector<CDNProvider>& cdns
    );
    
    // 헬스 체크 및 페일오버
    void monitorDistributionHealth(const std::string& contentId);
};
```

## 구현 순서

1. **Month 5**: DRM 패키징 시스템 구축
2. **Month 6**: 멀티 CDN 관리 및 글로벌 배포 통합

## 호환성 요구사항

- v5.1 VOD 시스템과 통합
- 기존 로컬 편집 기능 유지
- DRM/CDN 기능은 엔터프라이즈 옵션

## 성공 지표

- [ ] Widevine/FairPlay/PlayReady DRM 지원
- [ ] 3개 이상 CDN 동시 관리
- [ ] 글로벌 50개 리전 커버
- [ ] 실시간 품질 모니터링 및 ABR 조정

---

*Generated: 2025년 12월 6일*  
*For Claude AI Implementation*
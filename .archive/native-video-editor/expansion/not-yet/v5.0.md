# CLAUDE.md - native-video-editor v5.0 스트리밍 플랫폼 (라이브 스트리밍 인프라)

> AI 코딩 에이전트를 위한 프로젝트 컨텍스트 가이드 (시니어 레벨)

## 프로젝트 개요

### 선행 조건
- v4.2.0 GPU 가속 완료
- 실시간 트랜스코딩 가능

### 현재 상태 (v4.2.0)
- 완전 GPU 가속 파이프라인 (HW 디코더 + GPU 필터 + HW 인코더)
- 실시간 트랜스코딩 (1x 속도)
- 기존 WebGL/WebAudio 기능 유지

### 목표 상태 (v5.0.0)
- **라이브 스트리밍 인프라 구축**
- RTMP/WebRTC 인제스트 서버
- 실시간 트랜스코딩 클러스터
- 기본 Origin/Edge 서버

## 구현할 기능

### Phase 1: 라이브 스트리밍 인프라 (Month 1-2)

#### 1.1 시스템 아키텍처
```
┌────────────────────────────────────────────────────────────────┐
│                   Live Streaming Platform                       │
├────────────────────────────────────────────────────────────────┤
│                                                                 │
│  [Broadcaster]                                                  │
│       │                                                         │
│       ▼ RTMP/WebRTC                                            │
│  ┌─────────────┐                                                │
│  │   Ingest    │ ─── 인증, 키 검증                              │
│  │   Server    │                                                │
│  └──────┬──────┘                                                │
│         │                                                       │
│         ▼                                                       │
│  ┌─────────────┐                                                │
│  │ Transcoder  │ ─── ABR 인코딩 (1080p, 720p, 480p, 360p)       │
│  │  Cluster    │     GPU 가속 (v4.x 활용)                       │
│  └──────┬──────┘                                                │
│         │                                                       │
│         ▼                                                       │
│  ┌─────────────┐    ┌─────────────┐                             │
│  │   Origin    │───▶│    Edge     │ ─── HLS/DASH 배포            │
│  │   Server    │    │   Servers   │                             │
│  └─────────────┘    └──────┬──────┘                             │
│                            │                                    │
│                            ▼                                    │
│                     [Viewers]                                   │
│                                                                 │
└────────────────────────────────────────────────────────────────┘
```

#### 1.2 RTMP 인제스트 서버
```cpp
// RTMPIngestServer.hpp
class RTMPIngestServer {
public:
    struct StreamConfig {
        std::string streamKey;
        std::string channelId;
        int maxBitrate = 10000;  // kbps
        int maxResolution = 1080;
        bool recordEnabled = true;
    };

    struct IngestSession {
        std::string sessionId;
        std::string streamKey;
        TimePoint startTime;
        std::atomic<uint64_t> bytesReceived{0};
        std::atomic<bool> isLive{false};
    };

    // 스트림 시작/종료
    std::optional<IngestSession> startStream(const std::string& streamKey);
    void endStream(const std::string& sessionId);
    
    // 미디어 데이터 수신
    void onVideoFrame(const std::string& sessionId, const VideoFrame& frame);
    void onAudioFrame(const std::string& sessionId, const AudioFrame& frame);
    
    // 스트림 상태
    std::optional<StreamStatus> getStreamStatus(const std::string& channelId);

private:
    // 스트림 키 검증
    bool validateStreamKey(const std::string& streamKey);
    
    // 트랜스코더로 전달
    void forwardToTranscoder(const std::string& sessionId, const MediaFrame& frame);
    
    std::unordered_map<std::string, IngestSession> sessions_;
    std::unique_ptr<TranscoderRouter> transcoderRouter_;
};
```

#### 1.3 WebRTC 인제스트 (저지연)
```cpp
// WebRTCIngest.hpp
class WebRTCIngest {
public:
    struct WebRTCConfig {
        std::vector<std::string> iceServers;
        int maxBitrate = 6000;  // kbps
        bool simulcast = true;   // 멀티 해상도 전송
    };

    // SDP 교환
    std::string createOffer(const std::string& channelId);
    void setRemoteDescription(const std::string& sessionId, const std::string& sdp);
    std::string createAnswer(const std::string& sessionId);
    
    // ICE Candidate
    void addIceCandidate(const std::string& sessionId, const IceCandidate& candidate);
    
    // 미디어 트랙 핸들링
    void onTrack(
        const std::string& sessionId,
        MediaType type,
        std::function<void(const MediaFrame&)> handler
    );

private:
    // libwebrtc 또는 Pion 기반 구현
    std::unique_ptr<PeerConnectionFactory> pcFactory_;
    std::unordered_map<std::string, PeerConnection> connections_;
};
```

#### 1.4 실시간 트랜스코딩
```cpp
// LiveTranscoder.hpp
class LiveTranscoder {
public:
    struct TranscodeProfile {
        std::string name;       // "1080p", "720p", "480p", "360p"
        int width, height;
        int bitrate;            // kbps
        int fps;
        std::string codec;      // "h264", "hevc", "vp9", "av1"
    };

    struct ABRLadder {
        std::vector<TranscodeProfile> profiles;
    };

    // 트랜스코딩 세션
    struct TranscodeSession {
        std::string sessionId;
        ABRLadder ladder;
        std::vector<std::unique_ptr<TranscoderWorker>> workers;
    };

    // 세션 생성
    std::unique_ptr<TranscodeSession> createSession(
        const std::string& sessionId,
        const ABRLadder& ladder
    );

    // 프레임 처리
    void processFrame(const std::string& sessionId, const MediaFrame& frame);

private:
    std::unordered_map<std::string, std::unique_ptr<TranscodeSession>> sessions_;
};
```

#### 1.5 Origin/Edge 서버
```cpp
// OriginServer.hpp
class OriginServer {
public:
    struct StreamSegment {
        std::string streamId;
        int segmentNumber;
        std::vector<uint8_t> data;
        TimePoint timestamp;
    };

    // 세그먼트 저장/검색
    void storeSegment(const StreamSegment& segment);
    std::optional<StreamSegment> getSegment(
        const std::string& streamId, 
        int segmentNumber
    );

    // 플레이리스트 생성
    std::string generatePlaylist(const std::string& streamId);

private:
    // Redis/Memory 기반 저장소
    std::unique_ptr<SegmentStore> store_;
};
```

## 구현 순서

1. **Month 1**: RTMP/WebRTC 인제스트 서버 구축
2. **Month 2**: 트랜스코딩 클러스터 및 Origin/Edge 서버 통합

## 호환성 요구사항

- v4.x GPU 가속과 통합 (트랜스코딩에 활용)
- 기존 로컬 편집 기능 유지
- 스트리밍 기능은 옵션 모듈로 활성화

## 성공 지표

- [ ] RTMP/WebRTC 스트림 수신 가능
- [ ] ABR 트랜스코딩 4개 해상도 동시 생성
- [ ] HLS/DASH 스트리밍 배포
- [ ] 1000개 동시 스트림 지원

---

*Generated: 2025년 12월 6일*  
*For Claude AI Implementation*
# cpp-pvp-server — 프로덕션 배틀 아레나 게임 서버 초기 설계서
> 백지 상태에서 시작하는 한국 게임 업계 포트폴리오용 실시간 대전 게임 서버

---

## 1. 프로젝트 비전 & 동기

### 1.1 왜 이 프로젝트인가?

**목표 회사:**
- Nexon, Krafton, Netmarble, Kakao Games
- 한국 게임 업계 게임 서버 개발자 포지션

**현실적 문제:**
- 게임 서버 개발자 채용에서 요구하는 핵심 역량:
  - 실시간 네트워크 프로그래밍
  - 고성능 C++ 개발
  - 동시성 처리 및 상태 동기화
  - 대규모 동시 접속 처리
- 단순 웹 백엔드와 게임 서버는 완전히 다른 도메인
- 실제 플레이 가능한 게임이 있어야 역량 증명

**해결 방향:**
- **3개의 체크포인트**: 각각 완성된 플레이 가능 게임
- **점진적 복잡도 증가**: 1v1 → 60인 배틀로얄 → E-스포츠
- **프로덕션 품질**: 모니터링, 메트릭, 부하 테스트 포함

### 1.2 프로젝트 목표

```
"한국 게임 업계 채용 요구사항과 100% 매칭되는
 프로덕션 품질 실시간 게임 서버를 구현하여
 주니어부터 시니어까지 역량을 증명한다"
```

**달성 기준:**
| 체크포인트 | 목표 포지션 | 증명 사항 |
|-----------|------------|----------|
| **Checkpoint A** | 주니어/엔트리 | 실시간 1v1 대전, 60 TPS, 기본 전투 |
| **Checkpoint B** | 미들급 | 60인 동시 접속, 공간 분할, 네트워크 최적화 |
| **Checkpoint C** | 시니어급 | E-스포츠 플랫폼, K8s, 글로벌 확장 |

---

## 2. 설계 철학

### 2.1 핵심 원칙

#### 원칙 1: 체크포인트 독립성
```
각 체크포인트는 완전한 게임:
- Checkpoint A: 1v1 듀얼 게임 (단독 출시 가능)
- Checkpoint B: 60인 배틀로얄 (단독 출시 가능)
- Checkpoint C: E-스포츠 플랫폼 (단독 출시 가능)
```

- 각 체크포인트 완료 시 데모 가능
- 이력서에 해당 체크포인트까지 기재
- 점진적 학습 곡선

#### 원칙 2: 프로덕션 우선
```
모든 기능에는 증거가 필요:
- 성능 주장 → 벤치마크 결과
- 안정성 주장 → 부하 테스트 결과
- 확장성 주장 → 메트릭 대시보드
```

#### 원칙 3: 서버 권위 (Authoritative Server)
```
클라이언트는 입력만 전송:
┌─────────────┐     ┌─────────────┐
│   Client    │────►│   Server    │
│  (입력만)   │     │ (모든 연산) │
└─────────────┘◄────└─────────────┘
                  (상태 브로드캐스트)
```

- 치트 방지의 기본
- 결정론적 시뮬레이션
- 리플레이 시스템 기반

### 2.2 기술 스택 결정 근거

| 기술 | 선택 이유 | 한국 업계 매칭 |
|------|----------|---------------|
| **C++17** | 게임 서버 표준, 성능 | ✓ 필수 |
| **Boost.Asio** | 비동기 I/O, 산업 표준 | ✓ Nexon/Krafton |
| **Boost.Beast** | WebSocket, HTTP | ✓ 브라우저 지원 |
| **PostgreSQL** | 세션 영속화, 리더보드 | ✓ 표준 |
| **Redis** | 실시간 데이터, 매치메이킹 | ✓ 필수 |
| **Protocol Buffers** | 직렬화, 언어 독립 | ✓ 표준 |
| **Prometheus/Grafana** | 관측성 | ✓ 필수 |

---

## 3. 체크포인트 로드맵

### 3.1 전체 로드맵 개요

```
┌─────────────────────────────────────────────────────────────────┐
│                      cpp-pvp-server 로드맵                             │
├─────────────┬───────────────────────────────────────────────────┤
│ Checkpoint  │ 1v1 Duel Game (주니어 포트폴리오)                 │
│     A       │ 기간: 8-10주                                      │
│             │                                                   │
│  MVP 1.0    │ - WebSocket 서버 (Boost.Beast)                    │
│             │ - 60 TPS 게임 루프                                │
│             │ - WASD + 마우스 이동                              │
│             │ - PostgreSQL 세션 기록                            │
│  MVP 1.1    │ - 발사체 시스템 (클릭 투 슈팅)                    │
│             │ - 원-원 충돌 감지                                 │
│             │ - 데미지 시스템 (100 HP, 20 데미지/히트)          │
│  MVP 1.2    │ - ELO 기반 매치메이킹                             │
│             │ - 대기열 관리 (허용 범위 확대)                    │
│             │ - 10+ 동시 매치 지원                              │
│  MVP 1.3    │ - 사후 매치 통계                                  │
│             │ - ELO 레이팅 시스템                               │
│             │ - 글로벌 리더보드                                 │
├─────────────┼───────────────────────────────────────────────────┤
│ Checkpoint  │ 60-Player Battle Royale (미들급 포트폴리오)       │
│     B       │ 기간: 10-12주                                     │
│             │                                                   │
│  MVP 2.0    │ - 60인 동시 접속                                  │
│             │ - 공간 분할 (Grid/Octree)                         │
│             │ - 관심 영역 관리 (Area of Interest)               │
│  MVP 2.1    │ - 맵 축소 시스템                                  │
│             │ - 안전 구역/데스존                                │
│             │ - 아이템 스폰 시스템                              │
│  MVP 2.2    │ - UDP 전환 (신뢰성 레이어)                        │
│             │ - 델타 압축                                       │
│             │ - 네트워크 최적화                                 │
├─────────────┼───────────────────────────────────────────────────┤
│ Checkpoint  │ Esports Platform (시니어 포트폴리오)              │
│     C       │ 기간: 6-8주                                       │
│             │                                                   │
│  MVP 3.0    │ - 토너먼트 시스템                                 │
│             │ - 관전 모드                                       │
│             │ - 리플레이 시스템                                 │
│  MVP 3.1    │ - Kubernetes 배포                                 │
│             │ - 수평 확장                                       │
│             │ - 글로벌 리전 라우팅                              │
└─────────────┴───────────────────────────────────────────────────┘
```

### 3.2 핵심 성과 지표 (KPI)

**반드시 달성해야 할 모든 지표:**

| 메트릭 | 목표값 | 측정 방법 |
|--------|--------|----------|
| 서버 틱 레이트 | **60 TPS ±1** | Prometheus 히스토그램 |
| 클라이언트 지연 | **p99 ≤ 50ms** | 루프백 테스트 |
| 상태 동기화 | **≤ 16.67ms** | 틱 간격 |
| 동시 플레이어 | **60+** (Checkpoint B) | 부하 테스트 |
| 테스트 커버리지 | **≥ 70%** | gcov/lcov |
| 에러율 | **≤ 0.1%** | Prometheus 카운터 |

---

## 4. 아키텍처 스케치

### 4.1 시스템 아키텍처

```
┌─────────────────────────────────────────────────────────────────┐
│                         Clients                                 │
│                  (WebSocket / UDP)                              │
└─────────────────────────┬───────────────────────────────────────┘
                          │
┌─────────────────────────▼───────────────────────────────────────┐
│                    Game Server Cluster                          │
├─────────────────────────────────────────────────────────────────┤
│  ┌────────────────────────────────────────────────────────────┐ │
│  │              WebSocketServer / UdpServer                   │ │
│  │   (Boost.Asio 비동기 I/O, 연결 관리)                       │ │
│  └────────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────────┤
│  ┌────────────────────────────────────────────────────────────┐ │
│  │                     GameLoop (60 TPS)                      │ │
│  │   고정 시간 단계, 결정론적 시뮬레이션                      │ │
│  └────────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────────┤
│  ┌──────────────────┐  ┌──────────────────┐  ┌────────────────┐ │
│  │   GameSession    │  │    Matchmaker    │  │ PlayerProfile  │ │
│  │  (2-60 Players)  │  │   (ELO 기반)     │  │  (통계/랭킹)   │ │
│  │  - Movement      │  │  - 대기열 관리   │  │  - ELO 계산    │ │
│  │  - Combat        │  │  - 매치 생성     │  │  - 리더보드    │ │
│  │  - Projectiles   │  │                  │  │                │ │
│  └──────────────────┘  └──────────────────┘  └────────────────┘ │
└─────────────────────────┬───────────────────────────────────────┘
                          │
        ┌─────────────────┼─────────────────┬─────────────────┐
        ▼                 ▼                 ▼                 ▼
┌───────────────┐ ┌───────────────┐ ┌───────────────┐ ┌───────────────┐
│  PostgreSQL   │ │     Redis     │ │  Prometheus   │ │    Grafana    │
│  (세션/통계)  │ │  (실시간 큐)  │ │   (메트릭)    │ │  (대시보드)   │
└───────────────┘ └───────────────┘ └───────────────┘ └───────────────┘
```

### 4.2 게임 루프 구조

```cpp
// 핵심 게임 루프 구조
class GameLoop {
    std::atomic<bool> running{true};
    std::chrono::nanoseconds targetTickDuration{16'666'667};  // 60 TPS
    
    void run() {
        while (running) {
            auto tickStart = std::chrono::steady_clock::now();
            
            // 1. 입력 수집
            processInputs();
            
            // 2. 게임 상태 업데이트
            updateGameState();
            
            // 3. 충돌 감지
            detectCollisions();
            
            // 4. 상태 브로드캐스트
            broadcastState();
            
            // 5. 다음 틱까지 슬립
            auto elapsed = std::chrono::steady_clock::now() - tickStart;
            std::this_thread::sleep_for(targetTickDuration - elapsed);
        }
    }
};
```

### 4.3 디렉토리 구조

```
cpp-pvp-server/
├── .github/
│   └── workflows/
│       └── ci.yml                  # GitHub Actions CI
├── design/
│   ├── 0.0-initial-design.md       # 초기 설계서 (이 문서)
│   ├── mvp-1.0.md                  # 기본 게임 서버
│   ├── mvp-1.1.md                  # 전투 시스템
│   ├── mvp-1.2.md                  # 매치메이킹
│   └── mvp-1.3.md                  # 통계 & 랭킹
├── server/
│   ├── src/
│   │   ├── core/                   # 게임 루프, 틱 관리
│   │   │   ├── game_loop.h/cpp
│   │   │   ├── game_config.h/cpp
│   │   │   └── timer.h/cpp
│   │   ├── game/                   # 게임 로직
│   │   │   ├── game_session.h/cpp
│   │   │   ├── player_state.h/cpp
│   │   │   ├── projectile.h/cpp
│   │   │   └── combat.h/cpp
│   │   ├── network/                # 네트워크 레이어
│   │   │   ├── websocket_server.h/cpp
│   │   │   ├── message_handler.h/cpp
│   │   │   └── protocol.h
│   │   ├── storage/                # 데이터 영속화
│   │   │   ├── postgres_storage.h/cpp
│   │   │   └── redis_client.h/cpp
│   │   ├── match/                  # 매치메이킹
│   │   │   ├── matchmaker.h/cpp
│   │   │   ├── match_queue.h/cpp
│   │   │   └── elo_calculator.h/cpp
│   │   ├── stats/                  # 통계 & 랭킹
│   │   │   ├── player_profile.h/cpp
│   │   │   └── leaderboard.h/cpp
│   │   └── monitoring/             # 관측성
│   │       ├── prometheus_exporter.h/cpp
│   │       └── metrics.h
│   ├── include/                    # 공개 헤더
│   ├── tests/
│   │   ├── unit/
│   │   ├── integration/
│   │   └── performance/
│   ├── CMakeLists.txt
│   └── vcpkg.json                  # 의존성 관리
├── deployments/
│   ├── docker/
│   │   ├── Dockerfile
│   │   └── docker-compose.yml
│   └── kubernetes/                 # Checkpoint C
├── monitoring/
│   ├── prometheus/
│   │   └── prometheus.yml
│   └── grafana/
│       └── dashboards/
├── docs/
│   ├── mvp-specs/                  # 상세 MVP 요구사항
│   └── evidence/                   # 성능 증거
│       ├── checkpoint-a/
│       ├── checkpoint-b/
│       └── checkpoint-c/
├── tools/
│   └── test_client.py              # 테스트 클라이언트
└── README.md
```

---

## 5. 핵심 시스템 설계

### 5.1 GameSession 상태 모델

```cpp
struct PlayerState {
    uint32_t playerId;
    float x, y;           // 위치
    float angle;          // 방향 (라디안)
    int32_t health;       // 체력 (100)
    uint32_t lastSeq;     // 마지막 처리된 입력 시퀀스
    
    // 통계
    int32_t shotsFired;
    int32_t shotsHit;
    int32_t damageDealt;
    int32_t damageTaken;
};

struct Projectile {
    uint32_t ownerId;
    float x, y;
    float vx, vy;         // 속도 벡터 (30 m/s)
    float lifetime;       // 남은 수명 (1.5초)
};

class GameSession {
    std::array<PlayerState, 2> players;
    std::vector<Projectile> projectiles;
    uint32_t currentTick;
    
    void applyInput(uint32_t playerId, const MovementInput& input);
    void tick(float deltaTime);
    void broadcastState();
};
```

### 5.2 매치메이킹 알고리즘

```cpp
class Matchmaker {
    // ELO 기반 매칭
    struct QueuedPlayer {
        uint32_t playerId;
        int32_t elo;
        std::chrono::steady_clock::time_point queueTime;
    };
    
    // 매칭 로직
    std::optional<Match> tryMatch(QueuedPlayer& p1, QueuedPlayer& p2) {
        int32_t eloDiff = std::abs(p1.elo - p2.elo);
        auto waitTime = std::chrono::steady_clock::now() - p1.queueTime;
        
        // 초기 허용 범위: ±100, 5초마다 ±25 확대
        int32_t allowedDiff = 100 + (waitTime.count() / 5) * 25;
        
        if (eloDiff <= allowedDiff) {
            return Match{p1.playerId, p2.playerId};
        }
        return std::nullopt;
    }
};
```

### 5.3 충돌 감지

```cpp
// 원-원 충돌 (발사체 vs 플레이어)
bool checkCollision(const Projectile& proj, const PlayerState& player) {
    float dx = proj.x - player.x;
    float dy = proj.y - player.y;
    float distSq = dx * dx + dy * dy;
    
    const float projRadius = 0.2f;   // 발사체 반경
    const float playerRadius = 0.5f; // 플레이어 반경
    float sumRadius = projRadius + playerRadius;
    
    return distSq <= (sumRadius * sumRadius);
}
```

---

## 6. 네트워크 프로토콜

### 6.1 메시지 형식 (MVP 1.0 - 텍스트)

```
클라이언트 → 서버:
  input <player_id> <seq> <up> <down> <left> <right> <mouse_x> <mouse_y> <fire>
  예: input 1 42 1 0 0 1 320.5 240.0 0

서버 → 클라이언트:
  state <player_id> <x> <y> <angle> <health> <tick>
  예: state 1 150.0 200.0 1.57 80 1234
  
  hit <attacker_id> <target_id> <damage>
  예: hit 1 2 20
  
  death <player_id>
  예: death 2
```

### 6.2 메시지 형식 (MVP 2.0+ - Protocol Buffers)

```protobuf
message Input {
    uint32 player_id = 1;
    uint32 sequence = 2;
    bool up = 3;
    bool down = 4;
    bool left = 5;
    bool right = 6;
    float mouse_x = 7;
    float mouse_y = 8;
    bool fire = 9;
}

message GameState {
    uint32 tick = 1;
    repeated PlayerState players = 2;
    repeated Projectile projectiles = 3;
}
```

---

## 7. 성능 전략

### 7.1 Checkpoint A 최적화

| 영역 | 전략 | 목표 |
|------|------|------|
| 틱 타이밍 | 적응형 슬립 + 스핀 대기 | ±1ms 편차 |
| 메모리 | 객체 풀링 (발사체) | 할당 없는 틱 |
| 네트워크 | 배치 브로드캐스트 | 틱당 1 전송 |

### 7.2 Checkpoint B 최적화

| 영역 | 전략 | 목표 |
|------|------|------|
| 공간 분할 | Grid (1000x1000, 100x100 셀) | O(1) 이웃 검색 |
| 관심 영역 | 반경 100m 내 플레이어만 | 대역폭 90% 감소 |
| 델타 압축 | 변경된 필드만 전송 | 패킷 크기 80% 감소 |
| UDP | 커스텀 신뢰성 레이어 | 지연 50% 감소 |

---

## 8. 리스크 & 완화 전략

### 8.1 기술적 리스크

| 리스크 | 영향 | 완화 전략 |
|--------|------|----------|
| 60 TPS 유지 | 높음 | 프로파일링, 최적화 우선순위 |
| UDP 신뢰성 레이어 | 중간 | MVP 1.x에서 WebSocket으로 검증 |
| 60인 동시 접속 | 높음 | 점진적 부하 테스트 |

### 8.2 일정 리스크

| 리스크 | 영향 | 완화 전략 |
|--------|------|----------|
| Checkpoint A 지연 | 높음 | MVP 단위 완료, 조기 데모 |
| 복잡도 증가 | 중간 | 명확한 인터페이스 분리 |

---

## 9. 성공 지표

### 9.1 정량적 지표

```yaml
Checkpoint A:
  - [ ] 60 TPS ±1 유지
  - [ ] WebSocket 지연 p99 ≤ 20ms
  - [ ] 10+ 동시 매치 지원
  - [ ] 테스트 커버리지 ≥ 70%

Checkpoint B:
  - [ ] 60인 동시 접속
  - [ ] UDP 지연 p99 ≤ 50ms
  - [ ] 델타 압축 80% 감소
  
Checkpoint C:
  - [ ] K8s 수평 확장
  - [ ] 토너먼트 시스템 동작
  - [ ] 리플레이 시스템 동작
```

### 9.2 포트폴리오 체크리스트

```yaml
주니어 (Checkpoint A):
  - [x] 실시간 1v1 대전 게임 동작
  - [x] 60 TPS 서버 권위 시스템
  - [x] ELO 매치메이킹
  - [x] 리더보드 시스템

미들급 (Checkpoint B):
  - [ ] 60인 동시 접속 배틀로얄
  - [ ] 공간 분할 최적화
  - [ ] UDP + 신뢰성 레이어
  - [ ] 네트워크 최적화 증거

시니어급 (Checkpoint C):
  - [ ] K8s 배포 경험
  - [ ] E-스포츠 플랫폼
  - [ ] 글로벌 확장 아키텍처
```

---

## 10. 다음 단계

### 즉시 실행 항목

1. **MVP 1.0 시작**
   - GameLoop 구현 (60 TPS)
   - WebSocket 서버 구현
   - 기본 이동 물리
   - PostgreSQL 연동

2. **인프라 구축**
   - Docker Compose 설정
   - Prometheus + Grafana 설정
   - CI/CD 파이프라인

### 참고 문서
- [MVP 1.0 상세 설계](../docs/mvp-specs/mvp-1.0.md)
- [MVP 1.1 상세 설계](../docs/mvp-specs/mvp-1.1.md)
- [MVP 1.2 상세 설계](../docs/mvp-specs/mvp-1.2.md)
- [MVP 1.3 상세 설계](../docs/mvp-specs/mvp-1.3.md)

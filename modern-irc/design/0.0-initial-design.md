# modern-irc - Initial Design Document

> RFC 1459/2810-2813 기반 모던 IRC 서버 구현

---

## 1. 프로젝트 개요

### 1-1. 목표
- RFC 1459, 2810-2813 표준 기반 IRC 서버 구현
- C++17 표준으로 저수준 네트워크 프로그래밍 경험
- poll() 기반 논블로킹 I/O 멀티플렉싱 구현
- 프로덕션 수준의 인프라 (설정, 로깅, 모니터링)

### 1-2. 핵심 기술
| 영역 | 기술 |
|------|------|
| 언어 | C++17 |
| 네트워크 | TCP 소켓, poll() |
| 프로토콜 | IRC (RFC 1459, 2810-2813) |
| 인프라 | INI 설정, 파일 로깅, Rate Limiting |

### 1-3. 학습 목표
- TCP 소켓 프로그래밍 기초
- 논블로킹 I/O와 이벤트 기반 아키텍처
- 프로토콜 파싱 및 상태 관리
- 멀티 클라이언트 동시 처리

---

## 2. 아키텍처

### 2-1. 전체 구조
```
┌─────────────────────────────────────────────────────────────┐
│                      modern-irc Server                       │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │   Socket    │  │   Poller    │  │   Server    │         │
│  │  (network/) │  │  (network/) │  │   (core/)   │         │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘         │
│         │                │                │                 │
│         └────────────────┼────────────────┘                 │
│                          │                                  │
│  ┌─────────────┐  ┌──────┴──────┐  ┌─────────────┐         │
│  │   Client    │  │   Channel   │  │   Message   │         │
│  │   (core/)   │  │   (core/)   │  │   (core/)   │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                    Commands                          │   │
│  │  Auth | Channel | Message | Operator | Info          │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                     Utils                            │   │
│  │  Logger | Config | StringUtils | TopicPersistence    │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

### 2-2. 디렉토리 구조
```
modern-irc/
├── design/                    # 설계 문서
│   ├── 0.0-initial-design.md
│   ├── 1.0-core-functionality.md
│   ├── 2.0-advanced-features.md
│   └── 3.0-production-infrastructure.md
├── src/
│   ├── main.cpp
│   ├── core/                  # 핵심 클래스
│   │   ├── Server.cpp/hpp
│   │   ├── Client.cpp/hpp
│   │   ├── Channel.cpp/hpp
│   │   └── Message.cpp/hpp
│   ├── network/               # 네트워크 레이어
│   │   ├── Socket.cpp/hpp
│   │   └── Poller.cpp/hpp
│   ├── commands/              # IRC 명령어 핸들러
│   │   ├── AuthCommands.cpp/hpp
│   │   ├── ChannelCommands.cpp/hpp
│   │   ├── MessageCommands.cpp/hpp
│   │   ├── OperatorCommands.cpp/hpp
│   │   └── InfoCommands.cpp/hpp
│   └── utils/                 # 유틸리티
│       ├── Logger.cpp/hpp
│       ├── Config.cpp/hpp
│       ├── StringUtils.cpp/hpp
│       └── TopicPersistence.cpp/hpp
├── config/
│   └── modern-irc.conf
├── tests/
├── docs/
├── Makefile
└── README.md
```

---

## 3. 구현 단계 (MVP)

### Phase 1: Core Functionality (v1.0)
| 순서 | 작업 | 핵심 파일 |
|------|------|----------|
| 1.0.1 | TCP 소켓 서버 | `network/Socket.cpp` |
| 1.0.2 | poll() 이벤트 루프 | `network/Poller.cpp` |
| 1.0.3 | 클라이언트 연결 관리 | `core/Client.cpp` |
| 1.0.4 | IRC 메시지 파싱 | `core/Message.cpp` |
| 1.0.5 | 인증 (PASS/NICK/USER) | `commands/AuthCommands.cpp` |
| 1.0.6 | 채널 시스템 | `core/Channel.cpp`, `commands/ChannelCommands.cpp` |
| 1.0.7 | 메시지 전송 (PRIVMSG) | `commands/MessageCommands.cpp` |

### Phase 2: Advanced Features (v2.0)
| 순서 | 작업 | 핵심 파일 |
|------|------|----------|
| 2.0.1 | 채널 모드 (+i,+t,+k,+o,+l) | `core/Channel.cpp` |
| 2.0.2 | 오퍼레이터 명령 (KICK,INVITE,TOPIC) | `commands/OperatorCommands.cpp` |
| 2.0.3 | 정보 명령 (WHOIS,WHO) | `commands/InfoCommands.cpp` |
| 2.0.4 | RFC 에러 코드 구현 | 전체 |
| 2.0.5 | 토픽 영속화 | `utils/TopicPersistence.cpp` |

### Phase 3: Production Infrastructure (v3.0)
| 순서 | 작업 | 핵심 파일 |
|------|------|----------|
| 3.0.1 | 설정 파일 시스템 | `utils/Config.cpp` |
| 3.0.2 | 로깅 시스템 | `utils/Logger.cpp` |
| 3.0.3 | Rate Limiting | `core/Server.cpp` |
| 3.0.4 | 관리자 명령 (OPER,KILL,DIE) | `commands/OperatorCommands.cpp` |
| 3.0.5 | 서버 통계 (STATS,INFO) | `commands/InfoCommands.cpp` |

---

## 4. 핵심 컴포넌트

### 4-1. Server (core/Server.cpp)
```cpp
class Server {
public:
    Server(int port, const std::string& password);
    void run();                          // 메인 이벤트 루프
    
private:
    void handleNewConnection();          // 새 클라이언트 연결
    void handleClientData(int fd);       // 클라이언트 데이터 수신
    void processCommand(Client* client, const Message& msg);
    
    Socket _socket;
    Poller _poller;
    std::map<int, Client*> _clients;
    std::map<std::string, Channel*> _channels;
};
```

### 4-2. Client (core/Client.cpp)
```cpp
class Client {
public:
    enum State { CONNECTED, PASSWORD_SENT, REGISTERED };
    
    int getFd() const;
    const std::string& getNickname() const;
    bool isRegistered() const;
    void send(const std::string& message);
    
private:
    int _fd;
    State _state;
    std::string _nickname;
    std::string _username;
    std::string _realname;
    std::string _buffer;          // 수신 버퍼
    std::vector<Channel*> _channels;
};
```

### 4-3. Channel (core/Channel.cpp)
```cpp
class Channel {
public:
    void addClient(Client* client);
    void removeClient(Client* client);
    void broadcast(const std::string& message, Client* exclude = NULL);
    
    bool hasMode(char mode) const;
    void setMode(char mode, bool value);
    
private:
    std::string _name;
    std::string _topic;
    std::set<Client*> _clients;
    std::set<Client*> _operators;
    std::string _modes;           // +itko 등
    std::string _key;             // +k 비밀번호
    size_t _limit;                // +l 인원 제한
};
```

### 4-4. Message (core/Message.cpp)
```cpp
// IRC 메시지 형식: [:prefix] COMMAND [params] [:trailing]
class Message {
public:
    static Message parse(const std::string& raw);
    
    const std::string& getPrefix() const;
    const std::string& getCommand() const;
    const std::vector<std::string>& getParams() const;
    
private:
    std::string _prefix;
    std::string _command;
    std::vector<std::string> _params;
};
```

---

## 5. IRC 프로토콜

### 5-1. 필수 명령어
| 명령어 | 설명 | 예시 |
|--------|------|------|
| PASS | 서버 비밀번호 | `PASS secretpass` |
| NICK | 닉네임 설정 | `NICK alice` |
| USER | 사용자 등록 | `USER alice 0 * :Alice` |
| JOIN | 채널 참가 | `JOIN #general` |
| PART | 채널 떠나기 | `PART #general :bye` |
| PRIVMSG | 메시지 전송 | `PRIVMSG #general :hello` |
| QUIT | 연결 종료 | `QUIT :goodbye` |

### 5-2. 채널 모드
| 모드 | 설명 |
|------|------|
| +i | Invite only |
| +t | Topic 변경 제한 (op만) |
| +k | 채널 비밀번호 |
| +o | 오퍼레이터 권한 부여 |
| +l | 인원 제한 |

### 5-3. RFC 에러 코드
| 코드 | 이름 | 설명 |
|------|------|------|
| 401 | ERR_NOSUCHNICK | 닉네임 없음 |
| 403 | ERR_NOSUCHCHANNEL | 채널 없음 |
| 431 | ERR_NONICKNAMEGIVEN | 닉네임 미제공 |
| 433 | ERR_NICKNAMEINUSE | 닉네임 중복 |
| 461 | ERR_NEEDMOREPARAMS | 파라미터 부족 |
| 464 | ERR_PASSWDMISMATCH | 비밀번호 불일치 |
| 473 | ERR_INVITEONLYCHAN | 초대 전용 채널 |
| 482 | ERR_CHANOPRIVSNEEDED | 오퍼 권한 필요 |

---

## 6. 빌드 및 실행

### 6-1. 빌드
```bash
make          # 빌드
make clean    # 오브젝트 파일 삭제
make fclean   # 전체 삭제
make re       # 재빌드
```

### 6-2. 실행
```bash
./modern-irc <port> <password>
./modern-irc 6667 mypassword
```

### 6-3. 테스트
```bash
# 클라이언트 연결
nc localhost 6667

# 인증
PASS mypassword
NICK alice
USER alice 0 * :Alice

# 채널 참가 및 메시지
JOIN #general
PRIVMSG #general :Hello!
```

---

## 7. 학습 포인트

### 7-1. 네트워크 프로그래밍
- TCP 소켓 생성, bind, listen, accept
- 논블로킹 소켓 설정 (`fcntl`)
- poll() 이벤트 멀티플렉싱
- 부분 수신/전송 처리

### 7-2. 프로토콜 구현
- RFC 문서 기반 프로토콜 파싱
- 상태 머신 (클라이언트 등록 과정)
- 에러 처리 및 응답 코드

### 7-3. 시스템 설계
- 멀티 클라이언트 동시 처리
- 채널 기반 브로드캐스트
- 리소스 관리 및 정리

---

## 8. 선행 지식

### 8-1. 필수
- `prerequisite/c++/01-cpp17-server-ffmpeg-minimum-basics.md`
- `prerequisite/server-basic/02-socket-tcp-udp.md`
- `prerequisite/server-basic/03-io-model-blocking-nonblocking.md`

### 8-2. 권장
- `prerequisite/server-basic/01-process-vs-thread.md`
- `prerequisite/c++/02-cpp17-memory-raii-error-logging.md`

---

## 9. 참고 자료

- [RFC 1459 - Internet Relay Chat Protocol](https://tools.ietf.org/html/rfc1459)
- [RFC 2810 - IRC Architecture](https://tools.ietf.org/html/rfc2810)
- [RFC 2811 - IRC Channel Management](https://tools.ietf.org/html/rfc2811)
- [RFC 2812 - IRC Client Protocol](https://tools.ietf.org/html/rfc2812)
- [RFC 2813 - IRC Server Protocol](https://tools.ietf.org/html/rfc2813)

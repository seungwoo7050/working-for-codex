# modern-irc - Phase 2: Advanced Features

> 채널 모드, 오퍼레이터 명령, 정보 명령, RFC 에러 코드 구현

---

## 1. 개요

### 1-1. Phase 2 목표
- 채널 모드 시스템 (+i, +t, +k, +o, +l)
- 오퍼레이터 전용 명령어 구현
- 정보 조회 명령어 구현
- RFC 표준 에러 코드 확장

### 1-2. 구현 범위
| 기능 | 상태 |
|------|------|
| 채널 모드 (+i, +t, +k, +o, +l) | ✅ |
| 오퍼레이터 명령 (KICK, INVITE, TOPIC) | ✅ |
| 정보 명령 (WHOIS, WHO) | ✅ |
| RFC 에러 코드 (21+) | ✅ |
| 메시지 히스토리 | ✅ |
| 토픽 영속화 | ✅ |

---

## 2. 채널 모드 시스템

### 2-1. 모드 정의
| 모드 | 파라미터 | 설명 |
|------|---------|------|
| +i | - | Invite only (초대 전용) |
| +t | - | Topic 변경 제한 (오퍼만) |
| +k | password | 채널 비밀번호 설정 |
| +o | nickname | 오퍼레이터 권한 부여/제거 |
| +l | limit | 최대 인원 제한 |

### 2-2. Channel 클래스 확장
```cpp
// core/Channel.hpp
class Channel {
public:
    // 모드 관련
    bool hasMode(char mode) const;
    void setMode(char mode, bool enable);
    std::string getModeString() const;
    
    // +k (key)
    void setKey(const std::string& key);
    const std::string& getKey() const;
    bool checkKey(const std::string& key) const;
    
    // +l (limit)
    void setLimit(size_t limit);
    size_t getLimit() const;
    bool isFull() const;
    
    // +o (operator)
    void addOperator(Client* client);
    void removeOperator(Client* client);
    bool isOperator(Client* client) const;
    
    // +i (invite)
    void addInvited(Client* client);
    bool isInvited(Client* client) const;
    void removeInvited(Client* client);
    
private:
    std::string _modes;               // 현재 설정된 모드
    std::string _key;                 // +k 비밀번호
    size_t _limit;                    // +l 제한
    std::set<Client*> _operators;     // 오퍼레이터
    std::set<Client*> _invited;       // 초대된 사용자
};
```

### 2-3. MODE 명령어 처리
```cpp
// commands/ChannelCommands.cpp
void handleMode(Server& server, Client* client, const Message& msg) {
    if (msg.getParams().empty()) {
        client->send(":server 461 " + client->getNickname() + " MODE :Not enough parameters\r\n");
        return;
    }
    
    const std::string& target = msg.getParams()[0];
    
    // 채널 모드
    if (target[0] == '#') {
        Channel* channel = server.findChannel(target);
        if (!channel) {
            client->send(":server 403 " + client->getNickname() + " " + target + " :No such channel\r\n");
            return;
        }
        
        // 모드 조회 (파라미터 없을 때)
        if (msg.getParams().size() == 1) {
            client->send(":server 324 " + client->getNickname() + " " + target + " " + channel->getModeString() + "\r\n");
            return;
        }
        
        // 모드 변경 (오퍼레이터만)
        if (!channel->isOperator(client)) {
            client->send(":server 482 " + client->getNickname() + " " + target + " :You're not channel operator\r\n");
            return;
        }
        
        processChannelMode(server, client, channel, msg);
    }
}

void processChannelMode(Server& server, Client* client, Channel* channel, const Message& msg) {
    const std::string& modeString = msg.getParams()[1];
    size_t paramIndex = 2;
    bool adding = true;
    
    for (size_t i = 0; i < modeString.size(); i++) {
        char c = modeString[i];
        
        if (c == '+') {
            adding = true;
            continue;
        }
        if (c == '-') {
            adding = false;
            continue;
        }
        
        switch (c) {
            case 'i':  // Invite only
                channel->setMode('i', adding);
                break;
                
            case 't':  // Topic lock
                channel->setMode('t', adding);
                break;
                
            case 'k':  // Key (password)
                if (adding && paramIndex < msg.getParams().size()) {
                    channel->setKey(msg.getParams()[paramIndex++]);
                    channel->setMode('k', true);
                } else if (!adding) {
                    channel->setKey("");
                    channel->setMode('k', false);
                }
                break;
                
            case 'o':  // Operator
                if (paramIndex < msg.getParams().size()) {
                    Client* target = server.findClientByNick(msg.getParams()[paramIndex++]);
                    if (target && channel->hasClient(target)) {
                        if (adding)
                            channel->addOperator(target);
                        else
                            channel->removeOperator(target);
                    }
                }
                break;
                
            case 'l':  // Limit
                if (adding && paramIndex < msg.getParams().size()) {
                    int limit = std::atoi(msg.getParams()[paramIndex++].c_str());
                    if (limit > 0) {
                        channel->setLimit(limit);
                        channel->setMode('l', true);
                    }
                } else if (!adding) {
                    channel->setLimit(0);
                    channel->setMode('l', false);
                }
                break;
        }
    }
    
    // 모드 변경 알림
    std::string modeMsg = ":" + client->getNickname() + " MODE " + channel->getName() + " " + modeString;
    // 파라미터 추가...
    modeMsg += "\r\n";
    channel->broadcast(modeMsg);
}
```

---

## 3. 오퍼레이터 명령어

### 3-1. KICK
```cpp
// commands/OperatorCommands.cpp
void handleKick(Server& server, Client* client, const Message& msg) {
    if (msg.getParams().size() < 2) {
        client->send(":server 461 " + client->getNickname() + " KICK :Not enough parameters\r\n");
        return;
    }
    
    const std::string& channelName = msg.getParams()[0];
    const std::string& targetNick = msg.getParams()[1];
    std::string reason = msg.getParams().size() > 2 ? msg.getParams()[2] : client->getNickname();
    
    Channel* channel = server.findChannel(channelName);
    if (!channel) {
        client->send(":server 403 " + client->getNickname() + " " + channelName + " :No such channel\r\n");
        return;
    }
    
    if (!channel->hasClient(client)) {
        client->send(":server 442 " + client->getNickname() + " " + channelName + " :You're not on that channel\r\n");
        return;
    }
    
    if (!channel->isOperator(client)) {
        client->send(":server 482 " + client->getNickname() + " " + channelName + " :You're not channel operator\r\n");
        return;
    }
    
    Client* target = server.findClientByNick(targetNick);
    if (!target || !channel->hasClient(target)) {
        client->send(":server 441 " + client->getNickname() + " " + targetNick + " " + channelName + " :They aren't on that channel\r\n");
        return;
    }
    
    // KICK 메시지 브로드캐스트
    std::string kickMsg = ":" + client->getNickname() + " KICK " + channelName + " " + targetNick + " :" + reason + "\r\n";
    channel->broadcast(kickMsg);
    
    // 대상 제거
    channel->removeClient(target);
    target->leaveChannel(channel);
}
```

### 3-2. INVITE
```cpp
void handleInvite(Server& server, Client* client, const Message& msg) {
    if (msg.getParams().size() < 2) {
        client->send(":server 461 " + client->getNickname() + " INVITE :Not enough parameters\r\n");
        return;
    }
    
    const std::string& targetNick = msg.getParams()[0];
    const std::string& channelName = msg.getParams()[1];
    
    Client* target = server.findClientByNick(targetNick);
    if (!target) {
        client->send(":server 401 " + client->getNickname() + " " + targetNick + " :No such nick/channel\r\n");
        return;
    }
    
    Channel* channel = server.findChannel(channelName);
    if (!channel) {
        client->send(":server 403 " + client->getNickname() + " " + channelName + " :No such channel\r\n");
        return;
    }
    
    if (!channel->hasClient(client)) {
        client->send(":server 442 " + client->getNickname() + " " + channelName + " :You're not on that channel\r\n");
        return;
    }
    
    // +i 모드일 때 오퍼레이터만 초대 가능
    if (channel->hasMode('i') && !channel->isOperator(client)) {
        client->send(":server 482 " + client->getNickname() + " " + channelName + " :You're not channel operator\r\n");
        return;
    }
    
    if (channel->hasClient(target)) {
        client->send(":server 443 " + client->getNickname() + " " + targetNick + " " + channelName + " :is already on channel\r\n");
        return;
    }
    
    // 초대 목록에 추가
    channel->addInvited(target);
    
    // 응답
    client->send(":server 341 " + client->getNickname() + " " + targetNick + " " + channelName + "\r\n");
    target->send(":" + client->getNickname() + " INVITE " + targetNick + " " + channelName + "\r\n");
}
```

### 3-3. TOPIC
```cpp
void handleTopic(Server& server, Client* client, const Message& msg) {
    if (msg.getParams().empty()) {
        client->send(":server 461 " + client->getNickname() + " TOPIC :Not enough parameters\r\n");
        return;
    }
    
    const std::string& channelName = msg.getParams()[0];
    Channel* channel = server.findChannel(channelName);
    
    if (!channel) {
        client->send(":server 403 " + client->getNickname() + " " + channelName + " :No such channel\r\n");
        return;
    }
    
    if (!channel->hasClient(client)) {
        client->send(":server 442 " + client->getNickname() + " " + channelName + " :You're not on that channel\r\n");
        return;
    }
    
    // 토픽 조회
    if (msg.getParams().size() == 1) {
        if (channel->getTopic().empty()) {
            client->send(":server 331 " + client->getNickname() + " " + channelName + " :No topic is set\r\n");
        } else {
            client->send(":server 332 " + client->getNickname() + " " + channelName + " :" + channel->getTopic() + "\r\n");
        }
        return;
    }
    
    // 토픽 변경
    // +t 모드일 때 오퍼레이터만 변경 가능
    if (channel->hasMode('t') && !channel->isOperator(client)) {
        client->send(":server 482 " + client->getNickname() + " " + channelName + " :You're not channel operator\r\n");
        return;
    }
    
    const std::string& newTopic = msg.getParams()[1];
    channel->setTopic(newTopic);
    
    // 토픽 변경 알림
    std::string topicMsg = ":" + client->getNickname() + " TOPIC " + channelName + " :" + newTopic + "\r\n";
    channel->broadcast(topicMsg);
    
    // 영속화
    server.getTopicPersistence().saveTopic(channelName, newTopic);
}
```

---

## 4. 정보 명령어

### 4-1. WHOIS
```cpp
// commands/InfoCommands.cpp
void handleWhois(Server& server, Client* client, const Message& msg) {
    if (msg.getParams().empty()) {
        client->send(":server 431 " + client->getNickname() + " :No nickname given\r\n");
        return;
    }
    
    const std::string& targetNick = msg.getParams()[0];
    Client* target = server.findClientByNick(targetNick);
    
    if (!target) {
        client->send(":server 401 " + client->getNickname() + " " + targetNick + " :No such nick/channel\r\n");
        return;
    }
    
    // 311 - 사용자 정보
    client->send(":server 311 " + client->getNickname() + " " + target->getNickname() + 
                 " " + target->getUsername() + " " + target->getHostname() + 
                 " * :" + target->getRealname() + "\r\n");
    
    // 319 - 채널 목록
    std::string channels = target->getChannelList();
    if (!channels.empty()) {
        client->send(":server 319 " + client->getNickname() + " " + target->getNickname() + 
                     " :" + channels + "\r\n");
    }
    
    // 312 - 서버 정보
    client->send(":server 312 " + client->getNickname() + " " + target->getNickname() + 
                 " " + server.getName() + " :modern-irc server\r\n");
    
    // 318 - End of WHOIS
    client->send(":server 318 " + client->getNickname() + " " + target->getNickname() + 
                 " :End of /WHOIS list\r\n");
}
```

### 4-2. WHO
```cpp
void handleWho(Server& server, Client* client, const Message& msg) {
    if (msg.getParams().empty()) {
        client->send(":server 315 " + client->getNickname() + " * :End of /WHO list\r\n");
        return;
    }
    
    const std::string& mask = msg.getParams()[0];
    
    if (mask[0] == '#') {
        // 채널 멤버 조회
        Channel* channel = server.findChannel(mask);
        if (channel) {
            const std::set<Client*>& members = channel->getClients();
            for (std::set<Client*>::const_iterator it = members.begin(); it != members.end(); ++it) {
                Client* member = *it;
                std::string flags = "H";  // Here
                if (channel->isOperator(member))
                    flags += "@";
                
                client->send(":server 352 " + client->getNickname() + " " + mask + 
                             " " + member->getUsername() + " " + member->getHostname() +
                             " " + server.getName() + " " + member->getNickname() +
                             " " + flags + " :0 " + member->getRealname() + "\r\n");
            }
        }
    }
    
    client->send(":server 315 " + client->getNickname() + " " + mask + " :End of /WHO list\r\n");
}
```

---

## 5. RFC 에러 코드

### 5-1. 구현된 에러 코드
| 코드 | 상수명 | 메시지 |
|------|--------|--------|
| 401 | ERR_NOSUCHNICK | No such nick/channel |
| 403 | ERR_NOSUCHCHANNEL | No such channel |
| 404 | ERR_CANNOTSENDTOCHAN | Cannot send to channel |
| 405 | ERR_TOOMANYCHANNELS | You have joined too many channels |
| 411 | ERR_NORECIPIENT | No recipient given |
| 412 | ERR_NOTEXTTOSEND | No text to send |
| 421 | ERR_UNKNOWNCOMMAND | Unknown command |
| 431 | ERR_NONICKNAMEGIVEN | No nickname given |
| 432 | ERR_ERRONEUSNICKNAME | Erroneous nickname |
| 433 | ERR_NICKNAMEINUSE | Nickname is already in use |
| 441 | ERR_USERNOTINCHANNEL | They aren't on that channel |
| 442 | ERR_NOTONCHANNEL | You're not on that channel |
| 443 | ERR_USERONCHANNEL | is already on channel |
| 451 | ERR_NOTREGISTERED | You have not registered |
| 461 | ERR_NEEDMOREPARAMS | Not enough parameters |
| 462 | ERR_ALREADYREGISTRED | You may not reregister |
| 464 | ERR_PASSWDMISMATCH | Password incorrect |
| 471 | ERR_CHANNELISFULL | Cannot join channel (+l) |
| 473 | ERR_INVITEONLYCHAN | Cannot join channel (+i) |
| 475 | ERR_BADCHANNELKEY | Cannot join channel (+k) |
| 482 | ERR_CHANOPRIVSNEEDED | You're not channel operator |

---

## 6. 토픽 영속화

### 6-1. TopicPersistence 클래스
```cpp
// utils/TopicPersistence.hpp
class TopicPersistence {
public:
    TopicPersistence(const std::string& filepath = "topics.dat");
    
    void saveTopic(const std::string& channel, const std::string& topic);
    std::string loadTopic(const std::string& channel);
    void loadAll(std::map<std::string, std::string>& topics);
    
private:
    std::string _filepath;
    void saveAll(const std::map<std::string, std::string>& topics);
};
```

---

## 7. JOIN 확장 (모드 검사)

```cpp
void handleJoin(Server& server, Client* client, const Message& msg) {
    // ... 기존 코드 ...
    
    Channel* channel = server.findChannel(channelName);
    
    if (channel) {
        // +i (invite only) 검사
        if (channel->hasMode('i') && !channel->isInvited(client)) {
            client->send(":server 473 " + client->getNickname() + " " + channelName + " :Cannot join channel (+i)\r\n");
            return;
        }
        
        // +k (key) 검사
        if (channel->hasMode('k')) {
            std::string providedKey = msg.getParams().size() > 1 ? msg.getParams()[1] : "";
            if (!channel->checkKey(providedKey)) {
                client->send(":server 475 " + client->getNickname() + " " + channelName + " :Cannot join channel (+k)\r\n");
                return;
            }
        }
        
        // +l (limit) 검사
        if (channel->hasMode('l') && channel->isFull()) {
            client->send(":server 471 " + client->getNickname() + " " + channelName + " :Cannot join channel (+l)\r\n");
            return;
        }
        
        // 초대 사용됨 (제거)
        channel->removeInvited(client);
    } else {
        // 새 채널 생성 - 생성자가 첫 오퍼레이터
        channel = server.createChannel(channelName);
        channel->addOperator(client);
    }
    
    // ... 나머지 JOIN 로직 ...
}
```

---

## 8. 커밋 포인트

```bash
git commit -m "feat(channel): implement channel modes (+i, +t, +k, +o, +l)"
git commit -m "feat(operator): implement KICK command"
git commit -m "feat(operator): implement INVITE command"
git commit -m "feat(operator): implement TOPIC command"
git commit -m "feat(info): implement WHOIS, WHO commands"
git commit -m "feat(error): implement RFC error codes (21+)"
git commit -m "feat(persist): implement topic persistence"
# v2.0.0 tag
```

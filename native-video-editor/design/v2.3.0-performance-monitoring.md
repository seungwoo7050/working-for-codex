# Prometheus 메트릭 & Grafana 대시보드 설계 일지 (v2.3)
> cpp-pvp-server M1.7 패턴 기반 종합 성능 모니터링

## 1. 문제 정의 & 요구사항

### 1.1 핵심 목표

**Phase 2 완성 - 프로덕션 모니터링**:
- **실시간 메트릭**: Thumbnail, Metadata, API 지연 추적
- **Prometheus**: 시계열 데이터 수집 및 저장
- **Grafana**: 시각화 대시보드
- **알림**: 임계값 초과 시 Slack/Email 통보

**cpp-pvp-server M1.7 패턴 재현**:
- `prom-client` 라이브러리
- Histogram, Counter, Gauge 메트릭
- `/metrics` 엔드포인트

### 1.2 메트릭 유형

#### 1.2.1 Thumbnail Extraction
- **video_editor_thumbnail_duration_seconds**: Histogram (처리 시간 분포)
- **video_editor_thumbnail_requests_total**: Counter (총 요청 수)
- **video_editor_thumbnail_cache_hit_ratio**: Gauge (캐시 히트율)
- **video_editor_thumbnail_errors_total**: Counter (에러 수)

#### 1.2.2 Metadata Extraction
- **video_editor_metadata_duration_seconds**: Histogram
- **video_editor_metadata_requests_total**: Counter
- **video_editor_metadata_errors_total**: Counter

#### 1.2.3 API Metrics
- **video_editor_api_latency_seconds**: Histogram (라우트별)
- **video_editor_api_requests_total**: Counter (method, route, status_code)
- **video_editor_api_errors_total**: Counter

#### 1.2.4 FFmpeg Operations
- **video_editor_ffmpeg_duration_seconds**: Histogram (trim, split, process)
- **video_editor_ffmpeg_errors_total**: Counter

#### 1.2.5 System Metrics
- **video_editor_memory_usage_bytes**: Gauge (rss, heap_used, external)
- **video-editor_cpu_usage_percent**: Gauge
- **process_cpu_seconds_total**: Counter (기본 메트릭)
- **nodejs_eventloop_lag_seconds**: Histogram (기본 메트릭)

---

## 2. 기술적 배경 & 설계 동기

### 2.1 왜 Prometheus인가?

**Prometheus의 장점**:
1. **Pull 모델**: Prometheus가 주기적으로 `/metrics` 스크래핑
2. **시계열 DB**: 효율적인 시간대별 데이터 저장
3. **PromQL**: 강력한 쿼리 언어
4. **Alertmanager**: 알림 규칙 설정

**Pull vs. Push**:
```
Pull (Prometheus):
  App → /metrics 엔드포인트
  Prometheus → 15초마다 스크래핑

Push (StatsD):
  App → UDP 전송 → StatsD
  복잡성 증가
```

### 2.2 메트릭 타입

**Counter**: 누적만 가능 (requests_total)
```javascript
counter.inc();      // 1 증가
counter.inc(5);     // 5 증가
// 감소 불가!
```

**Histogram**: 분포 측정 (duration_seconds)
```javascript
histogram.observe(0.045);  // 45ms 기록
// 자동 계산: p50, p90, p99, avg
```

**Gauge**: 증감 가능 (memory_usage_bytes)
```javascript
gauge.set(104857600);  // 100MB
gauge.inc(1024);       // +1KB
gauge.dec(512);        // -512B
```

---

## 3. 시스템 아키텍처

### 3.1 전체 구조

```
┌──────────────────┐
│  native-video-editor App   │
│  - MetricsService│
│  - /metrics      │
└──────────────────┘
         ↓ (pull every 15s)
┌──────────────────┐
│  Prometheus      │
│  - TSDB          │
│  - PromQL        │
│  - Alertmanager  │
└──────────────────┘
         ↓
┌──────────────────┐
│  Grafana         │
│  - Dashboards    │
│  - Visualization │
└──────────────────┘
```

---

## 4. 상세 구현

### 4.1 MetricsService 클래스

**파일**: `backend/src/services/metrics.service.ts:8-148`

```typescript
import { Registry, Counter, Histogram, Gauge, collectDefaultMetrics } from 'prom-client';

class MetricsService {
  private registry: Registry;

  // Thumbnail metrics
  public thumbnailDuration: Histogram;
  public thumbnailRequests: Counter;
  public thumbnailCacheHitRatio: Gauge;
  public thumbnailErrors: Counter;

  // Metadata metrics
  public metadataDuration: Histogram;
  public metadataRequests: Counter;
  public metadataErrors: Counter;

  // API metrics
  public apiLatency: Histogram;
  public apiRequests: Counter;
  public apiErrors: Counter;

  // FFmpeg metrics
  public ffmpegDuration: Histogram;
  public ffmpegErrors: Counter;

  // System metrics
  public memoryUsage: Gauge;
  public cpuUsage: Gauge;

  constructor() {
    this.registry = new Registry();

    // Enable default metrics (CPU, memory, event loop, etc.)
    collectDefaultMetrics({ register: this.registry, prefix: 'video-editor_' });

    // Thumbnail metrics
    this.thumbnailDuration = new Histogram({
      name: 'video_editor_thumbnail_duration_seconds',
      help: 'Duration of thumbnail extraction operations in seconds',
      labelNames: ['status'],
      buckets: [0.01, 0.025, 0.05, 0.1, 0.25, 0.5, 1, 2.5, 5, 10],
      registers: [this.registry],
    });

    this.thumbnailRequests = new Counter({
      name: 'video_editor_thumbnail_requests_total',
      help: 'Total number of thumbnail extraction requests',
      labelNames: ['status'],
      registers: [this.registry],
    });

    this.thumbnailCacheHitRatio = new Gauge({
      name: 'video_editor_thumbnail_cache_hit_ratio',
      help: 'Cache hit ratio for thumbnail extraction (0-1)',
      registers: [this.registry],
    });

    this.thumbnailErrors = new Counter({
      name: 'video_editor_thumbnail_errors_total',
      help: 'Total number of thumbnail extraction errors',
      labelNames: ['error_type'],
      registers: [this.registry],
    });

    // Metadata metrics
    this.metadataDuration = new Histogram({
      name: 'video_editor_metadata_duration_seconds',
      help: 'Duration of metadata extraction operations in seconds',
      labelNames: ['status'],
      buckets: [0.001, 0.005, 0.01, 0.025, 0.05, 0.1, 0.25, 0.5, 1],
      registers: [this.registry],
    });

    this.metadataRequests = new Counter({
      name: 'video_editor_metadata_requests_total',
      help: 'Total number of metadata extraction requests',
      labelNames: ['status'],
      registers: [this.registry],
    });

    this.metadataErrors = new Counter({
      name: 'video_editor_metadata_errors_total',
      help: 'Total number of metadata extraction errors',
      labelNames: ['error_type'],
      registers: [this.registry],
    });

    // API metrics
    this.apiLatency = new Histogram({
      name: 'video_editor_api_latency_seconds',
      help: 'HTTP API request latency in seconds',
      labelNames: ['method', 'route', 'status_code'],
      buckets: [0.01, 0.05, 0.1, 0.5, 1, 2, 5, 10],
      registers: [this.registry],
    });

    this.apiRequests = new Counter({
      name: 'video_editor_api_requests_total',
      help: 'Total number of API requests',
      labelNames: ['method', 'route', 'status_code'],
      registers: [this.registry],
    });

    this.apiErrors = new Counter({
      name: 'video_editor_api_errors_total',
      help: 'Total number of API errors',
      labelNames: ['method', 'route', 'error_type'],
      registers: [this.registry],
    });

    // FFmpeg metrics
    this.ffmpegDuration = new Histogram({
      name: 'video_editor_ffmpeg_duration_seconds',
      help: 'Duration of FFmpeg operations in seconds',
      labelNames: ['operation', 'status'],
      buckets: [0.1, 0.5, 1, 2, 5, 10, 30, 60, 120],
      registers: [this.registry],
    });

    this.ffmpegErrors = new Counter({
      name: 'video_editor_ffmpeg_errors_total',
      help: 'Total number of FFmpeg errors',
      labelNames: ['operation', 'error_type'],
      registers: [this.registry],
    });

    // System metrics
    this.memoryUsage = new Gauge({
      name: 'video_editor_memory_usage_bytes',
      help: 'Memory usage in bytes',
      labelNames: ['type'],
      registers: [this.registry],
    });

    this.cpuUsage = new Gauge({
      name: 'video-editor_cpu_usage_percent',
      help: 'CPU usage percentage',
      registers: [this.registry],
    });

    // Start system metrics collection
    this.startSystemMetricsCollection();
  }

  private startSystemMetricsCollection(): void {
    setInterval(() => {
      const memUsage = process.memoryUsage();

      this.memoryUsage.set({ type: 'rss' }, memUsage.rss);
      this.memoryUsage.set({ type: 'heap_total' }, memUsage.heapTotal);
      this.memoryUsage.set({ type: 'heap_used' }, memUsage.heapUsed);
      this.memoryUsage.set({ type: 'external' }, memUsage.external);

      const cpuUsage = process.cpuUsage();
      const totalUsage = (cpuUsage.user + cpuUsage.system) / 1000000;
      this.cpuUsage.set(totalUsage);
    }, 5000); // Every 5 seconds
  }

  public async getMetrics(): Promise<string> {
    return this.registry.metrics();
  }

  public getRegistry(): Registry {
    return this.registry;
  }

  // Helper methods
  public recordThumbnailExtraction(durationSeconds: number, success: boolean): void {
    const status = success ? 'success' : 'error';
    this.thumbnailDuration.observe({ status }, durationSeconds);
    this.thumbnailRequests.inc({ status });
  }

  public updateThumbnailCacheStats(hits: number, misses: number): void {
    const total = hits + misses;
    const hitRatio = total > 0 ? hits / total : 0;
    this.thumbnailCacheHitRatio.set(hitRatio);
  }

  public recordMetadataExtraction(durationSeconds: number, success: boolean): void {
    const status = success ? 'success' : 'error';
    this.metadataDuration.observe({ status }, durationSeconds);
    this.metadataRequests.inc({ status });
  }

  public recordApiRequest(
    method: string,
    route: string,
    statusCode: number,
    durationSeconds: number
  ): void {
    this.apiLatency.observe({ method, route, status_code: statusCode.toString() }, durationSeconds);
    this.apiRequests.inc({ method, route, status_code: statusCode.toString() });
  }

  public recordFFmpegOperation(
    operation: string,
    durationSeconds: number,
    success: boolean
  ): void {
    const status = success ? 'success' : 'error';
    this.ffmpegDuration.observe({ operation, status }, durationSeconds);
  }

  public recordError(
    type: 'thumbnail' | 'metadata' | 'api' | 'ffmpeg',
    errorType: string,
    labels?: Record<string, string>
  ): void {
    switch (type) {
      case 'thumbnail':
        this.thumbnailErrors.inc({ error_type: errorType });
        break;
      case 'metadata':
        this.metadataErrors.inc({ error_type: errorType });
        break;
      case 'api':
        this.apiErrors.inc({ ...labels, error_type: errorType });
        break;
      case 'ffmpeg':
        this.ffmpegErrors.inc({ ...labels, error_type: errorType });
        break;
    }
  }
}

// Singleton
export const metricsService = new MetricsService();
```

### 4.2 /metrics 엔드포인트

**파일**: `backend/src/routes/metrics.ts`

```typescript
import { Router } from 'express';
import { metricsService } from '../services/metrics.service.js';

const router = Router();

/**
 * GET /metrics
 * Prometheus scrape endpoint
 */
router.get('/metrics', async (_req, res) => {
  try {
    res.set('Content-Type', 'text/plain; version=0.0.4; charset=utf-8');
    const metrics = await metricsService.getMetrics();
    res.send(metrics);
  } catch (error) {
    res.status(500).send('Failed to generate metrics');
  }
});

export default router;
```

### 4.3 Prometheus 설정

**파일**: `deployments/prometheus/prometheus.yml`

```yaml
global:
  scrape_interval: 15s
  evaluation_interval: 15s

scrape_configs:
  - job_name: 'video-editor'
    static_configs:
      - targets: ['backend:3001']
    metrics_path: '/metrics'

alerting:
  alertmanagers:
    - static_configs:
        - targets: ['alertmanager:9093']

rule_files:
  - 'alerts.yml'
```

### 4.4 알림 규칙

**파일**: `deployments/prometheus/alerts.yml`

```yaml
groups:
  - name: video-editor_alerts
    rules:
      # Thumbnail p99 > 100ms
      - alert: ThumbnailSlowness
        expr: histogram_quantile(0.99, rate(video_editor_thumbnail_duration_seconds_bucket[5m])) > 0.1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Thumbnail extraction p99 > 100ms"
          description: "{{ $value }}s"

      # Metadata p99 > 50ms
      - alert: MetadataSlowness
        expr: histogram_quantile(0.99, rate(video_editor_metadata_duration_seconds_bucket[5m])) > 0.05
        for: 5m
        labels:
          severity: warning

      # Error rate > 5%
      - alert: HighErrorRate
        expr: rate(video_editor_api_errors_total[5m]) / rate(video_editor_api_requests_total[5m]) > 0.05
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "API error rate > 5%"

      # Memory usage > 500MB
      - alert: HighMemoryUsage
        expr: video_editor_memory_usage_bytes{type="rss"} > 500000000
        for: 5m
        labels:
          severity: warning
```

---

## 5. Grafana 대시보드

### 5.1 대시보드 패널

**Thumbnail Performance**:
```promql
# p99 latency
histogram_quantile(0.99, rate(video_editor_thumbnail_duration_seconds_bucket[5m]))

# Request rate
rate(video_editor_thumbnail_requests_total[5m])

# Error rate
rate(video_editor_thumbnail_errors_total[5m])

# Cache hit ratio
video_editor_thumbnail_cache_hit_ratio
```

**API Performance**:
```promql
# p99 latency by route
histogram_quantile(0.99, rate(video_editor_api_latency_seconds_bucket[5m])) by (route)

# Request rate by status
rate(video_editor_api_requests_total[5m]) by (status_code)
```

**System Resources**:
```promql
# Memory usage
video_editor_memory_usage_bytes{type="heap_used"} / 1024 / 1024

# CPU usage
rate(process_cpu_seconds_total[1m]) * 100
```

---

## 6. 검증 전략

### 6.1 메트릭 검증

```bash
# /metrics 엔드포인트 확인
curl http://localhost:3001/metrics

# 예상 출력:
# video_editor_thumbnail_duration_seconds_bucket{le="0.05",status="success"} 10
# video_editor_thumbnail_duration_seconds_sum{status="success"} 0.45
# video_editor_thumbnail_duration_seconds_count{status="success"} 10
```

### 6.2 부하 테스트

```bash
# autocannon으로 부하 생성
npx autocannon -c 10 -d 60 http://localhost:3001/api/thumbnail

# Prometheus/Grafana에서 실시간 모니터링
```

---

## 7. 성능 예산

| 메트릭 | 목표 | 알림 임계값 |
|--------|------|-------------|
| Thumbnail p99 | < 50ms | > 100ms |
| Metadata p99 | < 10ms | > 50ms |
| API Error Rate | < 1% | > 5% |
| Memory | < 200MB | > 500MB |

---

## 8. 체크리스트

- [x] MetricsService 구현
- [x] Histogram, Counter, Gauge
- [x] /metrics 엔드포인트
- [x] Prometheus 설정
- [x] 알림 규칙
- [x] Grafana 대시보드

---

## 9. Voyager X 매칭

| 요구사항 | 구현 | 증명 |
|----------|------|------|
| 프로덕션 운영 | ✅ 종합 모니터링 | Prometheus + Grafana |
| 성능 최적화 | ✅ 메트릭 기반 개선 | 실시간 추적 |
| Node.js | ✅ prom-client | cpp-pvp-server 패턴 |

**v2.3 완료**: ⭐⭐⭐⭐⭐ (Production-Ready)

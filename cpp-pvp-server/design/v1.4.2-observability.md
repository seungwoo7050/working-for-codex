# 관측성 & 부하 테스트 설계 (v1.4.2)
> UDP 메트릭, 패킷 손실 시뮬레이션, 부하 테스트, Grafana 대시보드 구현 설계

**상태**: ✅ 완료

---

## 1. 개요

### 1.1 목표
- UDP 전용 Prometheus 메트릭 추가
- 네트워크 조건 시뮬레이션 (패킷 손실, 지연)
- 재현 가능한 부하 테스트 프레임워크
- Grafana UDP 성능 대시보드

### 1.2 배경
UDP 기반 넷코드는 TCP와 다른 성능 특성을 가집니다:
- 패킷 손실률 측정 필요
- RTT(Round-Trip Time) 모니터링
- 예측 정확도 추적
- 리컨실리에이션 빈도 분석

---

## 2. 패치별 설계

### 2.1 패치 1.4.2-p1: UDP 메트릭 추가

#### 2.1.1 책임
- UDP 관련 Prometheus 메트릭 정의
- 실시간 메트릭 수집
- 기존 MetricsHttpServer 확장

#### 2.1.2 메트릭 정의
```cpp
// include/pvpserver/network/udp_metrics.h
namespace pvpserver::network {

/**
 * UDP 통신 품질 메트릭
 */
struct ConnectionQuality {
    float packet_loss_percent = 0.0f;    // 패킷 손실률
    float avg_rtt_ms = 0.0f;             // 평균 RTT
    float jitter_ms = 0.0f;              // 지터 (RTT 변동성)
    uint64_t packets_sent = 0;
    uint64_t packets_received = 0;
    uint64_t packets_lost = 0;
    uint64_t bytes_sent = 0;
    uint64_t bytes_received = 0;
};

/**
 * RTT 샘플 (라운드트립 시간 측정용)
 */
struct RttSample {
    uint32_t sequence;
    std::chrono::steady_clock::time_point sent_time;
    std::chrono::steady_clock::time_point recv_time;
    float rtt_ms;
};

/**
 * UDP 메트릭 수집기
 * - 클라이언트별 연결 품질 추적
 * - 패킷 손실/지터/RTT 측정
 * - Prometheus 형식 출력
 */
class UdpMetrics {
public:
    explicit UdpMetrics(size_t rtt_sample_window = 100);

    // 패킷 송신 기록
    void RecordPacketSent(const std::string& client_id, uint32_t sequence, size_t bytes);

    // 패킷 수신 기록
    void RecordPacketReceived(const std::string& client_id, uint32_t sequence, size_t bytes);

    // ACK 수신 (RTT 계산)
    void RecordAck(const std::string& client_id, uint32_t sequence);

    // 패킷 손실 감지
    void RecordPacketLoss(const std::string& client_id, uint32_t sequence);

    // 클라이언트별 연결 품질 조회
    ConnectionQuality GetConnectionQuality(const std::string& client_id) const;

    // 전체 서버 메트릭 조회
    ConnectionQuality GetAggregatedMetrics() const;

    // Prometheus 형식 문자열 출력
    std::string ExportPrometheus() const;

    // 클라이언트 메트릭 초기화 (연결 종료 시)
    void ClearClient(const std::string& client_id);

    // 전체 메트릭 리셋
    void Reset();

private:
    struct ClientMetrics {
        std::atomic<uint64_t> packets_sent{0};
        std::atomic<uint64_t> packets_received{0};
        std::atomic<uint64_t> packets_lost{0};
        std::atomic<uint64_t> bytes_sent{0};
        std::atomic<uint64_t> bytes_received{0};

        std::mutex rtt_mutex;
        std::vector<RttSample> rtt_samples;
        std::unordered_map<uint32_t, std::chrono::steady_clock::time_point> pending_acks;

        float CalculateAvgRtt() const;
        float CalculateJitter() const;
        float CalculatePacketLoss() const;
    };

    size_t rtt_sample_window_;
    mutable std::mutex clients_mutex_;
    std::unordered_map<std::string, std::unique_ptr<ClientMetrics>> clients_;

    ClientMetrics* GetOrCreateClient(const std::string& client_id);
    const ClientMetrics* GetClient(const std::string& client_id) const;
};

}  // namespace pvpserver::network
```

#### 2.1.3 Prometheus 출력 형식
```
# HELP pvp_udp_packets_total Total UDP packets
# TYPE pvp_udp_packets_total counter
pvp_udp_packets_total{direction="sent"} 12345
pvp_udp_packets_total{direction="received"} 12340
pvp_udp_packets_total{direction="lost"} 5

# HELP pvp_udp_bytes_total Total UDP bytes
# TYPE pvp_udp_bytes_total counter
pvp_udp_bytes_total{direction="sent"} 1234567
pvp_udp_bytes_total{direction="received"} 1234000

# HELP pvp_rtt_milliseconds RTT histogram
# TYPE pvp_rtt_milliseconds histogram
pvp_rtt_milliseconds_bucket{le="10"} 100
pvp_rtt_milliseconds_bucket{le="25"} 500
pvp_rtt_milliseconds_bucket{le="50"} 800
pvp_rtt_milliseconds_bucket{le="100"} 950
pvp_rtt_milliseconds_bucket{le="+Inf"} 1000

# HELP pvp_prediction_accuracy Prediction accuracy ratio
# TYPE pvp_prediction_accuracy gauge
pvp_prediction_accuracy 0.95

# HELP pvp_reconciliation_total Total reconciliations
# TYPE pvp_reconciliation_total counter
pvp_reconciliation_total 123
```

---

### 2.2 패치 1.4.2-p2: 패킷 손실 시뮬레이션

#### 2.2.1 책임
- 네트워크 조건 시뮬레이션 (테스트용)
- 패킷 손실, 지연, 중복, 순서 변경
- 설정 가능한 파라미터

#### 2.2.2 인터페이스
```cpp
// include/pvpserver/network/packet_simulator.h
namespace pvpserver::network {

/**
 * 네트워크 시뮬레이션 설정
 */
struct NetworkCondition {
    float packet_loss_percent = 0.0f;     // 0-100
    float latency_ms = 0.0f;               // 추가 지연
    float jitter_ms = 0.0f;                // 지연 변동성
    float duplicate_percent = 0.0f;        // 패킷 복제율
    float out_of_order_percent = 0.0f;     // 순서 뒤바뀜 비율

    // 프리셋 팩토리 메서드
    static NetworkCondition Perfect();     // 완벽한 네트워크
    static NetworkCondition GoodWifi();    // {0.5%, 20ms, 5ms, 0%, 0%}
    static NetworkCondition PoorWifi();    // {2%, 80ms, 30ms, 0.1%, 1%}
    static NetworkCondition Mobile4G();    // {1%, 50ms, 20ms, 0%, 0.5%}
    static NetworkCondition Mobile3G();    // {5%, 150ms, 50ms, 0.5%, 2%}
    static NetworkCondition Terrible();    // {10%, 300ms, 100ms, 1%, 5%}
};

/**
 * 지연된 패킷 정보
 */
struct DelayedPacket {
    std::vector<uint8_t> data;
    std::chrono::steady_clock::time_point delivery_time;
    std::string destination;

    bool operator>(const DelayedPacket& other) const {
        return delivery_time > other.delivery_time;
    }
};

/**
 * 패킷 시뮬레이터
 * - 네트워크 조건 시뮬레이션 (손실, 지연, 지터, 복제, 순서 변경)
 * - 테스트 및 디버깅용
 */
class PacketSimulator {
public:
    using PacketHandler = std::function<void(const std::vector<uint8_t>&, const std::string&)>;

    explicit PacketSimulator(NetworkCondition condition = NetworkCondition::Perfect());

    // 네트워크 조건 설정
    void SetCondition(const NetworkCondition& condition);
    NetworkCondition GetCondition() const;

    // 시뮬레이터 활성화/비활성화
    void SetEnabled(bool enabled);
    bool IsEnabled() const;

    // 패킷 전송 시뮬레이션
    // 반환값: 패킷이 즉시 전달되어야 하면 true
    bool SimulateSend(const std::vector<uint8_t>& data,
                      const std::string& destination,
                      PacketHandler on_deliver);

    // 지연된 패킷 처리 (틱마다 호출)
    void ProcessDelayedPackets(PacketHandler on_deliver);

    // 대기 중인 패킷 수
    size_t GetPendingPacketCount() const;

    // 통계
    struct Statistics {
        uint64_t total_packets = 0;
        uint64_t dropped_packets = 0;
        uint64_t delayed_packets = 0;
        uint64_t duplicated_packets = 0;
        uint64_t reordered_packets = 0;
    };
    Statistics GetStatistics() const;
    void ResetStatistics();

private:
    bool enabled_;
    NetworkCondition condition_;
    mutable std::mutex mutex_;

    std::mt19937 rng_;
    std::uniform_real_distribution<float> percent_dist_;
    std::normal_distribution<float> latency_dist_;

    std::priority_queue<DelayedPacket,
                       std::vector<DelayedPacket>,
                       std::greater<DelayedPacket>> delayed_queue_;

    Statistics stats_;

    bool ShouldDrop();
    bool ShouldDuplicate();
    bool ShouldReorder();
    std::chrono::steady_clock::time_point CalculateDeliveryTime();
};

}  // namespace pvpserver::network
```

#### 2.2.3 시뮬레이션 흐름
```
1. 패킷 전송 요청 (SimulateSend)
2. 손실 확률 체크 → 드롭 결정 (ShouldDrop)
3. 중복 확률 체크 → 복제 생성 (ShouldDuplicate)
4. 지연 계산 (latency_ms + jitter_ms)
5. 순서 변경 확률 체크 → 추가 지연 (ShouldReorder)
6. 지연 큐에 추가 (delayed_queue_)
7. ProcessDelayedPackets()로 시간 경과 후 전달
```

#### 2.2.4 프리셋 조건
```cpp
// 일반적인 네트워크 시나리오 (static 팩토리 메서드)
NetworkCondition::Perfect();    // 완벽 - 손실 없음
NetworkCondition::GoodWifi();   // 양호한 WiFi - 0.5% 손실, 20ms 지연
NetworkCondition::PoorWifi();   // 나쁜 WiFi - 2% 손실, 80ms 지연
NetworkCondition::Mobile4G();   // 4G 모바일 - 1% 손실, 50ms 지연
NetworkCondition::Mobile3G();   // 3G 모바일 - 5% 손실, 150ms 지연
NetworkCondition::Terrible();   // 최악 - 10% 손실, 300ms 지연 (스트레스 테스트)
```

---

### 2.3 패치 1.4.2-p3: 재현 가능한 부하 테스트

#### 2.3.1 책임
- GoogleTest 기반 성능 테스트 프레임워크
- UdpMetrics와 PacketSimulator 성능 측정
- 다양한 네트워크 조건 시뮬레이션 검증

#### 2.3.2 테스트 클래스 구조
```cpp
// server/tests/performance/udp_load_test.cpp
class UdpLoadTest : public ::testing::Test {
protected:
    void SetUp() override {
        metrics_.Reset();
    }

    UdpMetrics metrics_;
    PacketSimulator simulator_;
};
```

#### 2.3.3 주요 테스트 케이스

**1. 패킷 처리 처리량 테스트 (PacketThroughputBaseline)**
- 100 클라이언트 × 1000 패킷
- 성능 기준: 100,000+ ops/sec
```cpp
TEST_F(UdpLoadTest, PacketThroughputBaseline) {
    const int NUM_CLIENTS = 100;
    const int PACKETS_PER_CLIENT = 1000;
    // ... 처리량 측정 및 검증
    EXPECT_GT(ops_per_second, 100000.0);
}
```

**2. RTT 측정 정확도 테스트 (RttMeasurementAccuracy)**
- 시뮬레이션된 RTT와 측정값 비교
- ±30% 허용 오차

**3. 패킷 손실률 테스트 (PacketSimulatorLossRate)**
- 목표 손실률 vs 실제 손실률 검증
- ±2% 허용 오차

**4. 네트워크 조건 시뮬레이션 (NetworkConditionSimulation)**
```cpp
std::vector<TestCase> test_cases = {
    {"Perfect", NetworkCondition::Perfect()},
    {"GoodWifi", NetworkCondition::GoodWifi()},
    {"PoorWifi", NetworkCondition::PoorWifi()},
    {"Mobile4G", NetworkCondition::Mobile4G()},
    {"Mobile3G", NetworkCondition::Mobile3G()},
    {"Terrible", NetworkCondition::Terrible()}
};
```

**5. 멀티스레드 메트릭 수집 (MultithreadedMetricsCollection)**
- 8 스레드 동시 접근 테스트
- atomic 연산 정확성 검증

**6. Prometheus 출력 성능 (PrometheusExportPerformance)**
- 500 클라이언트 기준 1ms 이내 출력

**7. 패킷 직렬화 처리량 (PacketSerializationThroughput)**
- Snapshot 직렬화/역직렬화
- 성능 기준: 50,000+ packets/sec

**8. 60 TPS 시뮬레이션 (SteadyStateAt60TPS)**
- 300틱(5초) 동안 50클라이언트 처리
- 틱 예산(16.67ms)의 10% 이내

#### 2.3.4 테스트 출력 예시
```
[PERF] Packet recording throughput: 2500000 ops/sec
[PERF] Total time: 80.5 ms for 200000 operations
[PERF] Measured avg RTT: 51.2 ms (expected: ~50 ms)
[PERF] Target loss: 5%, Actual loss: 4.8%
[PERF] GoodWifi: Delivery=99.5%, Dropped=5, Duplicated=0, Reordered=0
[PERF] 60 TPS Simulation:
[PERF]   Avg tick time: 0.12 ms (budget: 16.67 ms)
[PERF]   Max tick time: 0.35 ms
[PERF]   Clients per tick: 50
```

---

### 2.4 패치 1.4.2-p4: Grafana 대시보드

#### 2.4.1 책임
- UDP 성능 시각화 대시보드
- 실시간 모니터링
- 알림 설정

#### 2.4.2 대시보드 구성
```json
// monitoring/grafana/dashboards/udp-dashboard.json
{
  "title": "UDP Netcode Performance",
  "panels": [
    {
      "title": "Packet Rate",
      "type": "graph",
      "targets": [
        {"expr": "rate(pvp_udp_packets_total[1m])"}
      ]
    },
    {
      "title": "Packet Loss Rate",
      "type": "gauge",
      "targets": [
        {"expr": "pvp_udp_packets_total{direction='lost'} / pvp_udp_packets_total{direction='sent'}"}
      ]
    },
    {
      "title": "RTT Distribution",
      "type": "heatmap",
      "targets": [
        {"expr": "pvp_rtt_milliseconds_bucket"}
      ]
    },
    {
      "title": "Prediction Accuracy",
      "type": "stat",
      "targets": [
        {"expr": "pvp_prediction_accuracy"}
      ]
    },
    {
      "title": "Reconciliation Rate",
      "type": "graph",
      "targets": [
        {"expr": "rate(pvp_reconciliation_total[1m])"}
      ]
    },
    {
      "title": "Delta Compression Ratio",
      "type": "graph",
      "targets": [
        {"expr": "avg(pvp_delta_ratio)"}
      ]
    }
  ]
}
```

#### 2.4.3 패널 상세

| 패널 | 타입 | 메트릭 | 설명 |
|------|------|--------|------|
| Packet Rate | Graph | `rate(pvp_udp_packets_total[1m])` | 초당 패킷 수 |
| Packet Loss | Gauge | `lost / sent` | 손실률 (%) |
| RTT Heatmap | Heatmap | `pvp_rtt_milliseconds_bucket` | RTT 분포 |
| Bandwidth | Graph | `rate(pvp_udp_bytes_total[1m])` | 대역폭 (bytes/s) |
| Predictions | Stat | `pvp_prediction_accuracy` | 예측 정확도 |
| Reconciliations | Graph | `rate(pvp_reconciliation_total[1m])` | 리컨실리에이션/초 |
| Delta Ratio | Graph | `avg(pvp_delta_ratio)` | 델타 압축률 |

#### 2.4.4 알림 규칙
```yaml
# Packet Loss Alert
- alert: HighPacketLoss
  expr: pvp_udp_packets_lost / pvp_udp_packets_sent > 0.05
  for: 1m
  labels:
    severity: warning
  annotations:
    summary: "High packet loss rate detected (> 5%)"

# High Latency Alert
- alert: HighLatency
  expr: pvp_rtt_milliseconds_avg > 100
  for: 2m
  labels:
    severity: warning
  annotations:
    summary: "Average RTT exceeds 100ms"

# Low Prediction Accuracy
- alert: LowPredictionAccuracy
  expr: pvp_prediction_accuracy < 0.90
  for: 5m
  labels:
    severity: info
  annotations:
    summary: "Prediction accuracy below 90%"
```

---

## 3. 기존 코드와의 연관성

### 3.1 영향받는 모듈
| 모듈 | 변경 유형 | 설명 |
|------|----------|------|
| `network/udp_metrics.h` | 신규 | UDP 메트릭 클래스 |
| `network/packet_simulator.h` | 신규 | 네트워크 시뮬레이터 |
| `network/metrics_http_server.cpp` | 수정 | UDP 메트릭 노출 |
| `tests/performance/` | 추가 | 부하 테스트 |
| `monitoring/grafana/` | 추가 | 대시보드 JSON |

### 3.2 의존성
```
UdpGameServer
    ├── UdpMetrics (메트릭 수집)
    └── PacketSimulator (테스트 시)

UdpLoadTest (GoogleTest)
    ├── UdpMetrics (메트릭 테스트)
    └── PacketSimulator (네트워크 조건 시뮬레이션)
```

---

## 4. 파일 구조

```
server/
├── include/pvpserver/
│   └── network/
│       ├── udp_metrics.h         # UDP 메트릭 수집기
│       └── packet_simulator.h    # 패킷 손실/지연 시뮬레이터
├── src/
│   └── network/
│       ├── udp_metrics.cpp
│       └── packet_simulator.cpp
└── tests/
    └── performance/
        └── udp_load_test.cpp     # GoogleTest 기반 부하 테스트

monitoring/
└── grafana/
    └── dashboards/
        └── udp-dashboard.json    # Grafana 대시보드
```

---

## 5. 성능 요구사항

| 메트릭 | 목표 | 테스트 검증 |
|--------|------|-------------|
| 메트릭 수집 오버헤드 | < 1% CPU | PacketThroughputBaseline |
| 메트릭 기록 처리량 | 100,000+ ops/sec | PacketThroughputBaseline |
| Prometheus 출력 | < 1ms | PrometheusExportPerformance |
| 패킷 직렬화 | 50,000+ packets/sec | PacketSerializationThroughput |
| 틱 처리 시간 | < 1.67ms (10% of 16.67ms) | SteadyStateAt60TPS |

---

## 6. 테스트 전략

### 6.1 메트릭 테스트
- Prometheus 형식 출력 검증
- 동시성 안전성 (MultithreadedMetricsCollection)
- RTT 측정 정확도 (RttMeasurementAccuracy)

### 6.2 시뮬레이터 테스트
- 손실률 확률 분포 검증 (PacketSimulatorLossRate)
- 다양한 네트워크 조건 시뮬레이션 (NetworkConditionSimulation)
- 프리셋 조건별 동작 확인

### 6.3 부하 테스트 검증
- 60 TPS 안정성 (SteadyStateAt60TPS)
- 멀티스레드 환경 안전성
- 메모리 누수 없음

---

## 7. 다음 버전 연결

v1.4.2에서 구축한 관측성 인프라는 이후 분산 시스템 구현의 기반이 됩니다:

| 현재 (v1.4.2) | 다음 (v2.0.0) | 연결점 |
|---------------|---------------|--------|
| UdpMetrics | 분산 세션 모니터링 | 서버간 메트릭 집계 |
| PacketSimulator | 서버간 통신 테스트 | gRPC 네트워크 시뮬레이션 |
| 부하 테스트 프레임워크 | 분산 부하 테스트 | 멀티 서버 시나리오 |

### 다음 단계: [v2.0.0-session-store.md](v2.0.0-session-store.md)
- Redis 기반 분산 세션 저장소
- 서버간 세션 공유
- PostgreSQL 영속화
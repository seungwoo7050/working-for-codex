# ray-tracer — 물리 기반 렌더링 엔진 초기 설계서
> 백지 상태에서 시작하는 레이 트레이싱 렌더러 구현 프로젝트

---

## 1. 프로젝트 비전 & 동기

### 1.1 왜 이 프로젝트인가?

**현실적 문제:**
- 컴퓨터 그래픽스의 핵심 원리를 피상적으로만 이해
- 수학적 개념(벡터, 광학, 확률)과 구현 사이의 간극
- 고성능 C++ 코드 작성 경험 부족

**해결 방향:**
- Peter Shirley의 "Ray Tracing" 시리즈를 기반으로 체계적 구현
- 수학적 원리 → 코드 구현 → 시각적 검증의 순환
- 최적화 기법 (BVH, 중요도 샘플링) 단계적 적용

### 1.2 프로젝트 목표

```
"광선 추적의 물리적 원리를 이해하고,
 C++17로 프로덕션 수준의 렌더링 엔진을 구현한다"
```

**달성 기준:**
1. 기본 레이 트레이싱 (반사, 굴절, 그림자) → **Phase 1**
2. 공간 분할 가속 (BVH) + 텍스처 시스템 → **Phase 2**
3. 몬테카를로 적분 + 중요도 샘플링 → **Phase 3**
4. 실시간 미리보기 (선택) → **Phase 4**

---

## 2. 설계 철학

### 2.1 핵심 원칙

#### 원칙 1: 물리적 정확성 우선
```
광선의 행동은 물리 법칙을 따른다:
- 반사 법칙: θᵢ = θᵣ
- 굴절 법칙: n₁ sin θ₁ = n₂ sin θ₂ (Snell's Law)
- 에너지 보존: 반사광 + 굴절광 + 흡수 = 입사광
```

#### 원칙 2: 점진적 복잡도 증가
```
Phase 1 (Weekend)
  └─ Phase 2 (Next Week)
      └─ Phase 3 (Rest of Your Life)
```

- 각 Phase는 이전 Phase의 코드를 확장
- 기능 추가 시 기존 인터페이스 유지
- 테스트로 회귀 방지

#### 원칙 3: 수학적 우아함
```cpp
// 벡터 연산은 수학 표기와 일치
Vec3 reflected = v - 2 * dot(v, n) * n;  // r = v - 2(v·n)n

// Monte Carlo 적분
// ∫f(x)dx ≈ (1/N) Σ f(xᵢ)/p(xᵢ)
Color sample = f(x) / pdf(x);
```

### 2.2 기술 스택 결정 근거

| 기술 | 선택 이유 | 대안 |
|------|----------|------|
| **C++17** | 성능, 템플릿, constexpr | Rust (학습 비용), Python (느림) |
| **CMake 3.20+** | 크로스 플랫폼, 현대적 문법 | Make (단순), Meson |
| **Google Test** | C++ 표준, 풍부한 매처 | Catch2, doctest |
| **PPM 출력** | 의존성 없음, 디버깅 용이 | PNG (라이브러리 필요) |

---

## 3. Phase 로드맵

### 3.1 전체 로드맵 개요

```
┌─────────────────────────────────────────────────────────────────┐
│                       ray-tracer 로드맵                             │
├─────────┬───────────────────────────────────────────────────────┤
│ Phase 1 │ "Ray Tracing in One Weekend"                          │
│         │ - Vec3, Ray, Camera 핵심 클래스                        │
│         │ - Sphere 기본 프리미티브                               │
│         │ - Lambertian, Metal, Dielectric 재질                  │
│         │ - 안티앨리어싱, 피사계 심도                            │
├─────────┼───────────────────────────────────────────────────────┤
│ Phase 2 │ "Ray Tracing: The Next Week"                          │
│         │ - BVH (Bounding Volume Hierarchy) 가속 구조           │
│         │ - Solid, Checker, Perlin 텍스처                       │
│         │ - Quad, Box 프리미티브                                │
│         │ - ConstantMedium 볼륨 렌더링                          │
│         │ - DiffuseLight 발광 재질                              │
├─────────┼───────────────────────────────────────────────────────┤
│ Phase 3 │ "Ray Tracing: The Rest of Your Life"                  │
│         │ - Monte Carlo 적분 이론                               │
│         │ - PDF (Probability Density Function) 시스템           │
│         │ - 중요도 샘플링 (Importance Sampling)                 │
│         │ - MixturePDF로 분산 최소화                            │
├─────────┼───────────────────────────────────────────────────────┤
│ Phase 4 │ 확장 (선택)                                            │
│ (선택)  │ - 삼각형 메시, OBJ 로더                               │
│         │ - 멀티스레딩 / GPU 가속                               │
│         │ - 실시간 미리보기                                     │
└─────────┴───────────────────────────────────────────────────────┘
```

### 3.2 Phase별 핵심 목표

#### Phase 1: 기본 레이 트레이서
```yaml
목표: "광선이 물체와 상호작용하는 기본 원리 구현"

핵심 클래스:
  - Vec3: 3D 벡터/점/색상 (통합 타입)
  - Ray: 광선 파라메트릭 표현 P(t) = O + t·D
  - Sphere: 구체 교차 판정 (이차방정식)
  - Camera: 가상 카메라 시스템
  - Material: 재질 인터페이스

재질 유형:
  - Lambertian: 확산 반사 (난반사)
  - Metal: 정반사 (거울)
  - Dielectric: 굴절 (유리, 물)

렌더링 기법:
  - 역추적 (Backward Tracing)
  - 재귀적 광선 반사/굴절
  - 안티앨리어싱 (다중 샘플링)
  - 피사계 심도 (렌즈 시뮬레이션)
```

#### Phase 2: 고급 기능 & 최적화
```yaml
목표: "렌더링 속도와 표현력 향상"

가속 구조:
  - AABB (Axis-Aligned Bounding Box)
  - BVH 트리 구축 및 탐색
  - O(N) → O(log N) 교차 판정

텍스처 시스템:
  - 인터페이스: Texture::value(u, v, p)
  - SolidColor: 단색
  - CheckerTexture: 체커보드 패턴
  - NoiseTexture: Perlin 노이즈

추가 프리미티브:
  - Quad: 사각형 평면
  - Box: 상자 (6개 Quad 조합)
  - ConstantMedium: 볼륨 (안개, 연기)

광원:
  - DiffuseLight: 발광 재질
  - Cornell Box 씬
```

#### Phase 3: Monte Carlo 적분
```yaml
목표: "수학적으로 정확한 전역 조명"

이론적 기반:
  - 렌더링 방정식: Lₒ = Lₑ + ∫fᵣLᵢ(ωᵢ)cos θ dωᵢ
  - Monte Carlo 추정: ∫f(x)dx ≈ Σf(xᵢ)/p(xᵢ)

PDF 시스템:
  - CosinePDF: 코사인 가중 샘플링
  - SpherePDF: 균일 구면 샘플링
  - HittablePDF: 광원 방향 샘플링
  - MixturePDF: PDF 혼합

중요도 샘플링:
  - 광원 직접 샘플링
  - BRDF 기반 샘플링
  - 분산 4-5배 감소

성과:
  - 동일 샘플 수에서 노이즈 대폭 감소
  - 물리적으로 정확한 조명
```

---

## 4. 아키텍처 스케치

### 4.1 클래스 계층 구조

```
┌─────────────────────────────────────────────────────────────────┐
│                        Core Layer                               │
├─────────────────────────────────────────────────────────────────┤
│  Vec3          Ray           Interval        Color              │
│  (Point3)      (origin,dir)  (min,max)       (RGB)              │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      Geometry Layer                             │
├─────────────────────────────────────────────────────────────────┤
│                         Hittable                                │
│                            │                                    │
│         ┌──────────────────┼──────────────────┐                │
│         ▼                  ▼                  ▼                │
│      Sphere             Quad            HittableList           │
│         │                  │                  │                │
│         ▼                  ▼                  ▼                │
│   MovingSphere        ConstantMedium      BVHNode             │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      Material Layer                             │
├─────────────────────────────────────────────────────────────────┤
│                         Material                                │
│                            │                                    │
│      ┌─────────────────────┼─────────────────────┐             │
│      ▼                     ▼                     ▼             │
│  Lambertian             Metal              Dielectric          │
│      │                                           │             │
│      ▼                                           ▼             │
│ DiffuseLight                               Isotropic           │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                       Texture Layer                             │
├─────────────────────────────────────────────────────────────────┤
│                          Texture                                │
│                             │                                   │
│       ┌─────────────────────┼─────────────────────┐            │
│       ▼                     ▼                     ▼            │
│   SolidColor          CheckerTexture        NoiseTexture       │
│                                                  │             │
│                                                  ▼             │
│                                               Perlin           │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                         PDF Layer (Phase 3)                     │
├─────────────────────────────────────────────────────────────────┤
│                            PDF                                  │
│                             │                                   │
│     ┌───────────────────────┼───────────────────────┐          │
│     ▼                       ▼                       ▼          │
│  CosinePDF              SpherePDF             HittablePDF      │
│                                                     │          │
│                                                     ▼          │
│                                                MixturePDF      │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                       Rendering Layer                           │
├─────────────────────────────────────────────────────────────────┤
│                          Camera                                 │
│                             │                                   │
│              ┌──────────────┴──────────────┐                   │
│              ▼                             ▼                   │
│         render()                    rayColor()                 │
│      (픽셀 순회)                  (재귀적 광선 추적)            │
└─────────────────────────────────────────────────────────────────┘
```

### 4.2 렌더링 파이프라인

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│   Camera    │────►│  Ray 생성   │────►│ 교차 판정   │
│ (설정 로드) │     │ (픽셀→월드) │     │ (BVH 탐색)  │
└─────────────┘     └─────────────┘     └──────┬──────┘
                                               │
                         ┌─────────────────────┘
                         ▼
                  ┌─────────────┐
                  │  HitRecord  │
                  │  생성       │
                  └──────┬──────┘
                         │
         ┌───────────────┼───────────────┐
         ▼               ▼               ▼
    ┌─────────┐    ┌─────────┐    ┌─────────┐
    │ 산란    │    │ 발광    │    │ 배경    │
    │(scatter)│    │(emitted)│    │(miss)   │
    └────┬────┘    └────┬────┘    └────┬────┘
         │              │              │
         └──────────────┴──────────────┘
                        │
                        ▼
                 ┌─────────────┐
                 │ 색상 누적   │
                 │ (재귀 종료) │
                 └──────┬──────┘
                        │
                        ▼
                 ┌─────────────┐
                 │ PPM 출력    │
                 │ (감마 보정) │
                 └─────────────┘
```

### 4.3 디렉토리 구조

```
ray-tracer/
├── .github/
│   └── workflows/
│       └── ci.yml              # GitHub Actions CI
├── design/
│   ├── 0.0-initial-design.md   # 초기 설계서 (이 문서)
│   ├── 1.0-basic-raytracer.md  # Phase 1 설계
│   ├── 2.0-advanced-features.md # Phase 2 설계
│   └── 3.0-monte-carlo.md      # Phase 3 설계
├── src/
│   ├── main.cpp                # 진입점, 씬 정의
│   ├── core/
│   │   ├── vec3.h              # 3D 벡터
│   │   ├── ray.h               # 광선
│   │   ├── camera.h            # 카메라
│   │   ├── color.h             # 색상 출력
│   │   └── interval.h          # 구간 유틸리티
│   ├── geometry/
│   │   ├── hittable.h          # 교차 판정 인터페이스
│   │   ├── hittable_list.h     # 객체 목록
│   │   ├── sphere.h            # 구체
│   │   ├── quad.h              # 사각형
│   │   ├── bvh_node.h          # BVH 노드
│   │   ├── aabb.h              # AABB
│   │   └── constant_medium.h   # 볼륨
│   ├── materials/
│   │   ├── material.h          # 재질 인터페이스
│   │   ├── lambertian.h        # 확산 반사
│   │   ├── metal.h             # 금속 반사
│   │   ├── dielectric.h        # 굴절
│   │   └── diffuse_light.h     # 발광
│   ├── textures/
│   │   ├── texture.h           # 텍스처 인터페이스
│   │   ├── solid_color.h       # 단색
│   │   ├── checker_texture.h   # 체커보드
│   │   ├── noise_texture.h     # 노이즈
│   │   └── perlin.h            # 펄린 노이즈
│   └── utils/
│       ├── pdf.h               # PDF 클래스들
│       ├── onb.h               # 정규직교기저
│       └── common.h            # 공통 유틸리티
├── tests/
│   ├── test_vec3.cpp           # Vec3 테스트
│   ├── test_ray.cpp            # Ray 테스트
│   ├── test_sphere.cpp         # Sphere 테스트
│   ├── test_bvh.cpp            # BVH 테스트
│   └── test_pdf.cpp            # PDF 테스트
├── output/                     # 렌더링 결과 이미지
├── CMakeLists.txt
└── README.md
```

---

## 5. 핵심 알고리즘 스케치

### 5.1 광선-구체 교차 판정

```
구체 방정식: |P - C|² = r²
광선 방정식: P(t) = O + tD

대입하면:
|O + tD - C|² = r²
t²(D·D) + 2t(D·(O-C)) + (O-C)·(O-C) - r² = 0

이차방정식 ax² + bx + c = 0 형태:
a = D·D
b = 2D·(O-C)
c = (O-C)·(O-C) - r²

판별식: Δ = b² - 4ac
- Δ < 0: 교차 없음
- Δ = 0: 접점 (1개)
- Δ > 0: 관통 (2개)

해: t = (-b ± √Δ) / 2a
```

### 5.2 재귀적 광선 추적

```cpp
Color rayColor(Ray& r, int depth, Hittable& world) {
    if (depth <= 0) return Color(0,0,0);  // 반사 한계
    
    HitRecord rec;
    if (!world.hit(r, Interval(0.001, INF), rec))
        return backgroundColor();  // 배경색
    
    Ray scattered;
    Color attenuation;
    Color emitted = rec.mat->emitted(rec.u, rec.v, rec.p);
    
    if (!rec.mat->scatter(r, rec, attenuation, scattered))
        return emitted;  // 발광만 (광원)
    
    // 재귀: 산란광 + 발광
    return emitted + attenuation * rayColor(scattered, depth-1, world);
}
```

### 5.3 BVH 구축 (Phase 2)

```
알고리즘:
1. 객체 목록을 랜덤 축으로 정렬
2. 중간점에서 두 그룹으로 분할
3. 각 그룹에 대해 재귀적으로 BVH 노드 생성
4. 부모 AABB = 자식 AABB들의 합집합

시간 복잡도:
- 구축: O(N log N)
- 탐색: O(log N)
```

### 5.4 Monte Carlo 중요도 샘플링 (Phase 3)

```
기본 Monte Carlo:
  E[f] = (1/N) Σ f(xᵢ)      where xᵢ ~ uniform

중요도 샘플링:
  E[f] = (1/N) Σ f(xᵢ)/p(xᵢ)  where xᵢ ~ p(x)

최적의 p(x):
  p(x) ∝ |f(x)|  (f와 비례하는 분포)

구현:
  - 광원 방향으로 샘플링 (HittablePDF)
  - BRDF 방향으로 샘플링 (CosinePDF)
  - 두 PDF 혼합 (MixturePDF)
```

---

## 6. 성능 목표

### 6.1 렌더링 성능

| 씬 | 해상도 | SPP | Phase 1 | Phase 2 (BVH) | Phase 3 (IS) |
|----|--------|-----|---------|---------------|--------------|
| Random Spheres (500) | 400×225 | 10 | ~150s | ~5s | ~5s |
| Cornell Box | 600×600 | 100 | N/A | ~60s | ~60s |
| Cornell Box | 600×600 | 1000 | N/A | ~600s | ~600s |

**목표:**
- BVH로 50배 이상 속도 향상
- 중요도 샘플링으로 동일 품질에 4-5배 적은 샘플

### 6.2 이미지 품질

| 기법 | 효과 |
|------|------|
| 안티앨리어싱 (10+ SPP) | 계단 현상 제거 |
| 감마 보정 (γ = 2.2) | 자연스러운 밝기 |
| 중요도 샘플링 | 노이즈 감소 |

---

## 7. 테스트 전략

### 7.1 유닛 테스트

```cpp
// Vec3 테스트
TEST(Vec3Test, DotProduct) {
    Vec3 a(1, 2, 3);
    Vec3 b(4, 5, 6);
    EXPECT_DOUBLE_EQ(dot(a, b), 32.0);  // 1*4 + 2*5 + 3*6
}

// Sphere 교차 테스트
TEST(SphereTest, RayHitsSphere) {
    Sphere s(Point3(0,0,-1), 0.5, nullptr);
    Ray r(Point3(0,0,0), Vec3(0,0,-1));
    HitRecord rec;
    EXPECT_TRUE(s.hit(r, Interval(0, INF), rec));
    EXPECT_NEAR(rec.t, 0.5, 0.001);
}
```

### 7.2 시각적 검증

각 Phase 완료 시 레퍼런스 이미지와 비교:
- Phase 1: 랜덤 구체 씬 (확산, 금속, 유리)
- Phase 2: Cornell Box (조명, 그림자)
- Phase 3: Cornell Box (노이즈 비교)

---

## 8. 리스크 & 완화 전략

### 8.1 기술적 리스크

| 리스크 | 영향 | 완화 전략 |
|--------|------|----------|
| 부동소수점 오차 | 중간 | nearZero() 함수, ε 값 조정 |
| 재귀 스택 오버플로우 | 낮음 | maxDepth 제한 (기본 50) |
| 랜덤 시드 재현성 | 낮음 | 시드 고정 옵션 제공 |

### 8.2 설계 리스크

| 리스크 | 영향 | 완화 전략 |
|--------|------|----------|
| Phase 간 인터페이스 변경 | 중간 | 추상 인터페이스 사전 정의 |
| 테스트 누락 | 중간 | CI 커버리지 체크 |

---

## 9. 성공 지표

### 9.1 정량적 지표

```yaml
테스트 커버리지: ≥ 80%
컴파일 경고: 0개
메모리 누수: 0개 (valgrind 검증)
Phase 1 렌더링: < 30초 (400×225, 10 SPP)
Phase 2 BVH 개선: ≥ 30배
Phase 3 노이즈 감소: ≥ 4배 (동일 SPP)
```

### 9.2 정성적 지표

- [ ] 광선 추적의 물리적 원리를 설명 가능
- [ ] Monte Carlo 적분의 수학적 기반 이해
- [ ] 코드를 읽으면 알고리즘이 명확히 드러남
- [ ] 새로운 재질/프리미티브 추가가 용이

---

## 10. 참고 자료

### 10.1 필수 참고서

1. **"Ray Tracing in One Weekend"** - Peter Shirley
   - https://raytracing.github.io/books/RayTracingInOneWeekend.html

2. **"Ray Tracing: The Next Week"** - Peter Shirley
   - https://raytracing.github.io/books/RayTracingTheNextWeek.html

3. **"Ray Tracing: The Rest of Your Life"** - Peter Shirley
   - https://raytracing.github.io/books/RayTracingTheRestOfYourLife.html

### 10.2 추가 참고 자료

- **Physically Based Rendering** (PBRT) - Matt Pharr et al.
- **Real-Time Rendering** - Tomas Akenine-Möller et al.
- **Fundamentals of Computer Graphics** - Steve Marschner

---

## 11. 다음 단계

### 즉시 실행 항목

1. **프로젝트 초기화**
   - CMake 프로젝트 생성
   - Google Test 설정
   - GitHub Actions CI

2. **Phase 1 시작**
   - Vec3 클래스 구현 및 테스트
   - Ray 클래스 구현
   - 첫 번째 이미지 렌더링 (그라데이션)

### 참고 문서
- [Phase 1 상세 설계](./1.0-basic-raytracer.md)
- [Phase 2 상세 설계](./2.0-advanced-features.md)
- [Phase 3 상세 설계](./3.0-monte-carlo-integration.md)

# v2.3.0: Caching & Compression

## 개요

응답 캐싱과 Gzip 압축을 통해 API 성능을 최적화합니다.
Spring Cache Abstraction을 사용하여 인메모리 캐시를 구현하고,
서버 측 압축을 활성화합니다.

## 목표

1. **캐시 매니저 설정** - TTL이 있는 캐시 구성
2. **@Cacheable 적용** - 핫 데이터 캐싱
3. **캐시 무효화** - @CacheEvict 전략
4. **Gzip 압축** - 응답 크기 감소

---

## §1 캐시 전략

### 1.1 캐시 유형

| 캐시 이름 | TTL | 용도 |
|----------|-----|------|
| `products` | 5분 | 상품 목록 |
| `product` | 30분 | 개별 상품 상세 |
| `categories` | 1시간 | 카테고리 목록 |
| `hot-items` | 1분 | 인기 상품 |

### 1.2 캐시 키 전략

```java
@Cacheable(value = "product", key = "#id")
public ProductResponse findById(Long id) { ... }

@Cacheable(value = "products", key = "'all'")
public List<ProductResponse> findAll() { ... }

@Cacheable(value = "products", key = "'search:' + #keyword")
public List<ProductResponse> search(String keyword) { ... }
```

---

## §2 구현 상세

### 2.1 CachingConfig

```java
package com.example.training.config;

import org.springframework.cache.CacheManager;
import org.springframework.cache.annotation.EnableCaching;
import org.springframework.cache.concurrent.ConcurrentMapCacheManager;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

/**
 * 캐시 설정
 */
@Configuration
@EnableCaching
public class CachingConfig {

    @Bean
    public CacheManager cacheManager() {
        return new ConcurrentMapCacheManager(
            "products", "product", "categories", "hot-items"
        );
    }
}
```

### 2.2 CachedProductService

```java
package com.example.training.cache.service;

import org.springframework.cache.annotation.CacheEvict;
import org.springframework.cache.annotation.Cacheable;
import org.springframework.stereotype.Service;

/**
 * 캐시 적용 상품 서비스
 */
@Service
public class CachedProductService {

    @Cacheable(value = "product", key = "#id")
    public ProductDTO findById(Long id) {
        // 실제 조회 로직
    }

    @Cacheable(value = "products", key = "'all'")
    public List<ProductDTO> findAll() {
        // 실제 조회 로직
    }

    @CacheEvict(value = {"product", "products"}, allEntries = true)
    public void clearCache() {
        // 캐시 무효화
    }

    @CacheEvict(value = "product", key = "#id")
    public void evictProduct(Long id) {
        // 특정 상품 캐시 무효화
    }
}
```

---

## §3 Gzip 압축

### 3.1 application.yml 설정

```yaml
server:
  compression:
    enabled: true
    min-response-size: 1024  # 1KB 이상만 압축
    mime-types:
      - application/json
      - application/xml
      - text/html
      - text/xml
      - text/plain
```

### 3.2 압축 효과

| 응답 크기 | 압축 전 | 압축 후 | 절감률 |
|----------|---------|---------|--------|
| 작은 JSON | 500B | 500B | 0% (미적용) |
| 중간 JSON | 5KB | 1.2KB | 76% |
| 큰 JSON | 50KB | 8KB | 84% |

---

## §4 파일 구조

```
src/main/java/com/example/training/
├── config/
│   └── CachingConfig.java
└── cache/
    └── service/
        └── CachedProductService.java

src/test/java/com/example/training/cache/
└── CachingTest.java
```

---

## §5 테스트

```java
@SpringBootTest
class CachingTest {

    @Autowired
    private CachedProductService service;

    @Autowired
    private CacheManager cacheManager;

    @Test
    void shouldCacheProductOnFirstCall() {
        // 첫 호출 - 캐시 미스
        service.findById(1L);

        // 캐시 확인
        Cache cache = cacheManager.getCache("product");
        assertThat(cache.get(1L)).isNotNull();

        // 두 번째 호출 - 캐시 히트
        service.findById(1L);  // DB 조회 없이 캐시에서 반환
    }
}
```

---

## §6 마이그레이션 체크리스트

- [ ] CachingConfig 클래스 추가
- [ ] @EnableCaching 활성화
- [ ] @Cacheable 어노테이션 적용
- [ ] @CacheEvict 전략 구현
- [ ] server.compression 설정 추가
- [ ] 캐싱 테스트 추가
- [ ] 모든 테스트 통과
